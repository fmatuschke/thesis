\cleardoublepage
\setcounter{chapter}{8}
\chapter{Simulation}
\label{cha:simulation_analysis}
% \minitoc
%
\todo{ylabel sideways or next to (0,1)?}
%
\section{Introduction}
%
This chapter focuses on the simulation of \ac{3D-PLI}.
The first part focuses on the determination of all required physical parameters of the tissue and the microscope as well as on the characterization of the simulation parameters.
These parameters are used to simulate the previously created models.
The simulations are evaluated using the routine algorithms implemented in \ac{fastPLI}.
The focus of the evaluations of the results is on the accuracy of the tilting analysis for different orientations and crossing configurations.
%
%
%
\section{Parameter characterisation}\label{sec:sim_choose_parameters}
%
\subsection{Optical resolution}
%
As described in \cref{sec:opticalResolution}, optical resolution depends on aberration and diffraction, which in turn depend on a variety of factors.
Optical resolution and resampling are modeled as described in \cref{sec:ccdOptic}.
%
\begin{figure}[!t]
\centering
\setlength{\tikzwidth}{0.35\textwidth} % bigger than 0.475 images???
\setlength{\tabcolsep}{0em}
\begin{tabular}{C{0.5\textwidth}C{0.5\textwidth}}
%
\includegraphics[height=\tikzwidth]{dev/wiki/USAF-1951.pdf} &
\inputtikz{dev/gfx/chap8/usaf_image} \\[-1em]
% 
\subcaptiontab{0.475\textwidth}{\label{fig:usaf}USAF chart from group -2 to 1: \url{https://en.wikipedia.org/wiki/1951_USAF_resolution_test_chart}} &
\subcaptiontab{0.475\textwidth}{\label{fig:usaf_image}Microscopic image with highlighted groups 7-6 to 8-2.} \\[4em]
% 
\inputtikz{dev/gfx/chap8/usaf_line_plots_lr} &
\inputtikz{dev/gfx/chap8/usaf_line_plots_up} \\[-1em]
%
\subcaptiontab{0.475\textwidth}{\label{fig:usaf_lines_lr}Centered line plots left to right} &
\subcaptiontab{0.475\textwidth}{\label{fig:usaf_lines_ud}Centered line plots top to bottom}
% 
\end{tabular}
\caption{\acs{LMP} data. Group 8-1 with $\SI{1.95}{\micro\meter}$ indicates a resulting resolution at about \dummy{} which corresponds to an optical convolution of $\opticsigma = \SI{0.75}{\pixel}$.}
\label{fig:USAF}
\end{figure}
%
To measure the optical resolution of the microscope, previous measurements and analyses are repeated \cite{MenzelMaster}.
For this purpose, the \textit{1951 United States Air Force (USAF) resolution test chart}\footnote{U.S. Air Force MIL-STD-150A standard of 1951} is used.
It consists of several patterns that have three slots with defined spacing and widths (see \cref{fig:usaf}).
They are arranged in fields of three vertical and horizontal lines.
The fields are arranged in a spiral that shrinks from group to group by a factor $\SI{0.5}{}$.
To determine the line width, the fields are ordered numerically by a main group $i$ and a subgroup $j$.
To determine the resolution of the microscope, it is necessary to determine the group from which the slits can still be resolved according to the Rayleigh criteria (see \cref{fig:rayleigh}).
For this purpose, the intensity profiles along the perpendicular line of the three slits (vertical and horizontal) are analyzed.
The variance of the measured intensity is measured by analyzing all parallel lines in the slits.
%
\paragraph{Results and Discussion}
\Cref{fig:usaf_image} shows a section of a captured \ac{LMP} setup image.
The highlighted areas show the analyzed groups 7-6 to 8-2.
The first area of group 7-6 \raisebox{.25em}{\tikzset{external/export next=false}\tikz \draw[RED,ultra thick,dashed](0,0)--(0.25,0);} has a line width of $\SI{2.19}{\micro\meter}$.
The second group 8-1 \raisebox{.25em}{\tikzset{external/export next=false}\tikz \draw[GREEN,ultra thick,dashed](0,0)--(0.25,0);} has a line width of $\SI{1.95}{\micro\meter}$.
The last group 8-2 \raisebox{.25em}{\tikzset{external/export next=false}\tikz \draw[BLUE,ultra thick,dashed](0,0)--(0.25,0);} has a linewidth of $\SI{1.74}{\micro\meter}$.
The intensity line profiles for the vertical and horizontal cases are shown in \cref{fig:usaf_lines_lr,fig:usaf_lines_ud}.
The Rayleigh criterion can be used to determine the resolution in the second group region and thus at $\SI{1.95}{\micro\meter}$.
This reproduces the measurements in the \cite{MenzelMaster}.
Therefore, the convolution to be applied (see \cref{sec:opticalResolution}) is set to $\opticsigma = \SI{0.75}{\pixel}$.
%
%
%
\subsection{Sensor gain and signal noise}\label{sec:sensorGain}
%
\begin{figure}[!t]
\centering
%
% \tikzset{external/export=false}
\setlength{\tikzwidth}{0.3\textwidth}
\setlength{\tikzheight}{0.3\textwidth}
% \tikzset{external/force remake}
%
\setlength{\tabcolsep}{0em}
\begin{tabular}{C{0.5\textwidth}C{0.5\textwidth}}
% \tikzset{external/remake next}
\inputtikz{gfx/pli/pli_focus}
&
\inputtikz{dev/gfx/2/PM_000_image}
\\[-1em]
%
% SUBCAPTIONS
\subcaptiontab{0.475\textwidth}{\label{fig:pliFocus}Scheme of unfocused microscopic image.} &
\subcaptiontab{0.475\textwidth}{\label{fig:pliFocusImage}Microscopic image} \\[2em]
%
% \tikzset{external/remake next}
\inputtikz{gfx/data/PM_noise}
&
\inputtikz{gfx/data/theo_noise}
\\[-1em]
%
% SUBCAPTIONS
\subcaptiontab{0.475\textwidth}{\label{fig:parameterModelNoise} Linear regression results in a gain factor of $\opticgain_{\mathit{LMP}} = \SI{0.1175}{}(?)$.} &
\subcaptiontab{0.475\textwidth}{\label{fig:noiseplot}Expected noise range for different species. \todo{check values}}
\end{tabular}
%
\caption{Intensity noise measurements and results}
\label{fig:parameterModelGain}
\end{figure}
%
As described in \cref{sec:ccdOptic}, optical noise must be modeled by a noise model.
In \cite{Wiese:887678}, the gain factor $\opticgain$ of the microscopic setup was measured by multiple measurements of an image with a variety of intensity values.
The gain factor describes the linearity between a measured signal and the corresponding noise.
The same type of measurement and analysis is performed here with the \ac{LMP} setup.
\par
To obtain statistics for a large number of intensity values, the sample stage is covered with a fully absorbing cover so that half of the image is dark.
In addition, the focal length is changed so that the light is spread over the entire image sensor under the cover (see \cref{fig:pliFocusImage}).
By measuring $N=\SI{500}{}$ images, the variance for the different intensity values is determined.
%
\paragraph{Results and discussion}
The results are shown in \cref{fig:parameterModelNoise} and show a gain value of $\opticgain_{\mathit{LMP}} = \SI{0.1175}{}(?)$, which matches the hardware specifications \todo{check and ref}.
This gain factor can be used by the model
\begin{align}
f(x) = \floor{\mathrm{normal}(\mu = x, \sigma=\sqrt{\opticgain x})+0.5}
\end{align}
for intensities $I > 0$, $I \gg \sqrt{\opticgain I}$ and integer values.
%
%
%
\subsection{Tissue properties}\label{sec:tissueProp}
%
\begin{figure}[p]
\centering
\setlength{\tikzwidth}{0.75\textwidth}
\begin{tabular}{c}
%
\tikzset{external/export next=false} % takes long for the first time
\inputtikz{gfx/data/vervet_transmittance} \\[-2em]
\subcaptiontab{0.75\textwidth}{\label{fig:brain_trans}Transmittance} \\[1.5em]
\tikzset{external/export next=false}% takes long for the first time
\inputtikz{gfx/data/vervet_retardation} \\[-2em]
\subcaptiontab{0.75\textwidth}{\label{fig:brain_ret}Retardation}
%
\end{tabular}
\caption{%
Transmittance and retardation map of a coronal section of a Vervet monkey $\SI{549}{}$.
The absorption coefficient and birefingence strength can be estimated from flat fibers, which are present in the corpus calosu (CC).
For this purpose, two \acsp{ROI} are annotated with $\SI{1125858}{\pixel}$ on the left and $\SI{1064629}{\pixel}$ on the right.}
\label{fig:brain_ret_trans}
\end{figure}
%
%
%
\begin{figure}[p]
% 2_simulation/0_parameter/measure_vervet.ipy
\centering
\setlength{\tikzwidth}{0.425\textwidth}
\setlength{\tabcolsep}{0em}
\begin{tabular}{C{0.5\textwidth}C{0.5\textwidth}}
%
\tikzset{external/export next=false}% takes long for the first time
\inputtikz{gfx/data/vervet_transmittance_zoom} &
\inputtikz{gfx/data/vervet_transmittance_hist} \\[-5mm]
%
\subcaptiontab{0.475\textwidth}{Zoom transmittance} &
\subcaptiontab{0.475\textwidth}{\label{fig:histTrans}Histogram transmittance} \\[10mm]
%
\tikzset{external/export next=false}
\inputtikz{gfx/data/vervet_retardation_zoom} &
\inputtikz{gfx/data/vervet_retardation_hist} \\[-5mm]
%
\subcaptiontab{0.475\textwidth}{Zoom retardation} &
\subcaptiontab{0.475\textwidth}{\label{fig:histRet}Histogram retardation} \\
%
\end{tabular}
\caption{%
trans left: $1200 \pm 500$,
trans right: $1200 \pm 500$,
bg: $4530 \pm 240$,
fuellgrad $0.75: \mu \approx 30 \pm 10$,
fuellgrad $0.75: \mu \approx 30 \pm 10$,
ret left: $0.83 \pm 0.07$,
ret right: $0.80 \pm 0.07$
\todo{what happens in the center?}}
\label{fig:brain_ret_trans_zoom}
% \end{figure}
%
% analog rodent:
% trans: $2100 \pm 600$,
% bg: $4000 \pm 50$,
% fuellgrad $0.75: \mu \approx 14 \pm 7$,
% ret: $0.40 \pm 0.11$,
% and human:
% trans: $170 \pm 80$,
% bg: $2700 \pm 110$,
% fuellgrad $0.75: \mu \approx 61 \pm 11$,
% ret: $0.68 \pm 0.11$,
%
%
\vspace*{2em}
% \begin{figure}[!t]
% \centering
\begin{tabular}{cc}
\includegraphics[page=2]{dev/rc1/tissue/birefringence_output_bf_rc1.pdf}&
\includegraphics[page=5]{dev/rc1/tissue/birefringence_output_bf_rc1.pdf}\\[1em]
\multicolumn{2}{c}{\includegraphics[page=7]{dev/rc1/tissue/birefringence_output_bf_rc1.pdf}}
\end{tabular}
\caption{Simulations of tissue to investigate transmittance and birefringence strengths at different \Voxelsize s \voxelsize{}. The experimental values (see \cref{fig:brain_ret_trans_zoom}) are reached similar at a value of about $\si{0.008}{}$.}
\label{fig:parameterModelSim}
\end{figure}
%
The absorption coefficient $\absorp{}$ and the birefringence $\dn{}$ have to be estimated from the tissue to use appropriate values for the simulation.
As the literature shows, these values are in the range of $\dn{}$ \dummy{}.
Since the models created here use stiff fiber segments the volume density cannot reach the high density usually present in \ac{WM}.
To overcome this problem, the absorption and birefringence strengths must be increased to obtain comparable results.
\par
%
For a measurement of the properties, it is important that a homogeneous region is selected.
In the coronal section, the corpus callosum is suitable for this purpose. 
It is the main fiber connection between the two cerebral hemispheres (see \cref{fig:brain_ret_trans}).
In a central section, the nerve fibers generally lie flat in the section.
\Cref{fig:brain_ret_trans} shows transmission and retardation maps of the coronal section of the velvet monkey, and \cref{fig:brain_ret_trans_zoom} shows a magnified version.
The retardation map shows a visible reduction in retardation in the center of the corpus callosum.
Therefore, this central region is neglected for homogeneity.
A left and a right region remain, which may be homogeneous in both transmission and retardation (see \cref{fig:histTrans,fig:histRet}).
The left region has $\SI{1125858}{}$ number of pixels, the right part $\SI{1064629}{}$.
The same measurements are performed for human and rodent in the corpus callosum (see Appendix). 
%
%
%
\subsubsection{Absorption}
%
When the light penetrates the tissue, it is absorbed in the matter on the one hand and scattered on the other.
Both effects can be modeled mathematically in this linear optical simulation as a decrease in intensity along the path.
A drawback of this simulation is that the scattering is not constant for all fiber configurations and orientations \cite{MenzelDissertation}.
Therefore, the measured absorption coefficient is only valid for the same fiber configurations as in the region.
The absorption only changes the transmittance and thus the relative noise, but not the delay or direction of the signal.
Since the noise is quite low in this microscopic configuration, it is unlikely to affect the results.
\par
%
To measure the absorption, the transmittance of the coronal slice in the \ac{ROI} of the corpus callosum is measured against the background value.
The absorption coefficient is then calculated by applying \dummy{}.
These values are then increased according to the volume fraction of the models and then simulated to ensure that the same behavior can be modeled.
%
\paragraph{Results and Discussion}
A relative transmittance of about $\SIrange{20}{30}{\percent}$ is present within the \ac{ROI} of the corpus callosum.
The simulation parameters must be set to achieve a similar transmittance value for the models.
This means that for a $\SI{60}{\micro\meter}$ thick section, the absorption coefficient $\absorp{}$ is about $\SI{30}{\milli\meter\tothe{-1}}$.
The absorption for the rodent is about $\SI{8}{\milli-meter-tothe{-1}}$ and that of the human is about $\SI{65}{\milli-meter-tothe{-1}}$.
\par
%
\Cref{fig:simTransValues} shows the simulated transmittance values for different fiber radii.
For smaler radii the variance of the transmittance is very small \dummy{} and increases with the radii.
This behavier is epected, since models with larger radii have more space where no tissue is present, and therefore the light can travel freely through the \say{section}.
In comparison to the histogram \cref{fig:brain_ret_trans_zoom} the models with larger radii have more in common with the distribution.
However from literature one can neglect, that this kind of fiber radii is present in corpus calosum \dummy{}.
Nevertheless the tissue can have more complicated configurations and effects, which leads to a larger viarity of absorption, \eg{} cells, blood vessels and so on.
Also at this point the here developed simulation is not ready to simulate scattered light, which is to be expected to increase the range of the absorption and therefore resulting a larger variance of transmittance.
%
%
%
\subsubsection{Birefringence}
%
The birefringence cannot simply be measured like the transmittance.
Due to the radial optical axis of the myelin, the relativ obsorving birefringence is smaller than the one of the myelin.
However the simulation up to a point has the same geometrical constrains.
By simulating difference birefringence strength and comparing them to the retardation of the tissue one can find a proper value.
The simulation will use a flat single fiber population and the same parameters as the later simulation model library (see \dummy{}).
%
\paragraph{Results and discussion}
The results in \cref{fig:parameterModelSim} show that to reach a retardation value similar to the experimental setup of around $\SI{0.8}{}$ a birefringence value of $\SI{0.008}{}$ for the microscopic model should be chosen.
Looking at the different model nerve fiber radii the variance of the retardation values increase strong, similar to the transmittance.
This is to be expected since the simulated tissue section has a hight of $\SI{60}{\micro\meter}$.
Therefore for a radii of $\SI{10}{\micro\meter}$ the number of tissue voxels has to vary depending on where the fibers are positioned in the volume.
For larger radii this leads to the problem, that the retardation cannot be over $\SI{1}{}$ and therefore the signal amplitude reduces again.
%
%
%
\subsection{\Voxelsize{} \texorpdfstring{\voxelsize{}}{}}
%
\begin{figure}[!t]%p
% 2_simulation/0_parameter/fiber_radii.py
\centering
\includegraphics[width=\textwidth, page=1]{dev/rc1/voxel_size/voxel_size_plots_data_r05_output_vs_135_0.01_6_25_vervet_r_rc1.pdf}
\caption{The mean difference is constant for smaller voxel sizes and starts to grow significantly only from $\voxelsize=\SI{0.1}{\micro\meter}$.}
\label{fig:voxelsizeNoise}
\end{figure}
%
The parameter \Voxelsize{} $\voxelsize$ is the most important parameter for simulation accuracy, as it determines how accurately the models are discretized.
Smaller values mean more details, more accurate optical axes and more light rays.
However, this also increases the number of calculations and memory by $O(n_{\mathit{voxel}}^3)$.
Therefore, it is recommended that the voxel size be as large as possible without introducing significant error due to discretization.
\par
%
To investigate this effect, a simulation is performed with different types of voxel sizes from the $\voxelsize = \SIrange{0.01}{1.3}{\micro\meter}$.
The smallest voxel size $\SI{0.01}{\micro\meter}$ is used as ground truth.
Since this voxel size is so small, only a volume of $3 \cdot \SI{1.3}{\micro\meter} \cdot \SI{1.3}{\micro\meter} 3 \cdot \SI{1.3}{\micro\meter} \times \SI{60}{\micro\meter}$ is used without tilt.
Otherwise, when using the tilt function, the volume would have to be increased so that the light beam still passes through the tissue.
The other parameters are set as in \dummy{}.
The models to be simulated are $(||,\modelInc = \SI{0}{\degree})$, $(||,\modelInc = \SI{90}{\degree})$, $(\times, \modelInc = \SI{0}{\degree})$, and $(\times,\modelInc = \SI{90}{\degree})$ with a fraction of $\modelPsi = \SI{0.5}{}$, since these configurations represent the extrema for two fiber populations.
To improve the statistics, the simulation is repeated in volume on an aquidistant $xy$ grid of $\num{5}$ by $\num{5}$ points within the $\SI{65}{\micro\meter}$ by $\SI{65}{\micro\meter}$ model.
%
\paragraph{Results and discussion}
The results in \cref{fig:voxelsizeNoise} show that the relative difference from the smallest voxel size increases statically significantly from a value of \SI{0.1}{\micro\meter}.
The variance of the relative difference increases with increasing voxel size from this value.
\par
%
The results shown in \cref{fig:voxelsizeNoise} indicate that when noise is present and the voxel size is smaller than $\SI{0.1}{\micro\meter}$, the accuracy does not increase with respect to the noise model chosen here.
However, this is only true for a pixel size of $\SI{1.3}{\micro\meter}$ and fiber radii of $\SI{0.5}{\micro\meter}$.
% 
%
%
\section{Simulation}
%
\subsection{Parameters}
\label{sec:simParameterEnv}
% 
\begin{table}[!b]
\caption{Simulation parameters}
\centering
% \sisetup{open-bracket={\{}, close-bracket={\}}, list-final-separator={,},list-pair-separator={,}}%
\pgfplotstabletypeset[%
    thesisTableStyle,
    column type=l,
    columns/variable/.style={string type},
    columns/value/.style={string type},
    every head row/.style={before row=\toprule,after row=\midrule},
    every last row/.style={after row=\bottomrule},
    col sep=&,
    row sep=\\,
]
{variable & value\\
%
simpli.voxel\_size & $\SI{0.1}{\micro\meter}$\\
simpli.pixel\_size & $\SI{1.3}{\micro\meter}$\\
simpli.voi & $[[\SI{-35}{\micro\meter}, \SI{-35}{\micro\meter}, \SI{-30}{\micro\meter}], [\SI{30}{\micro\meter}, \SI{35}{\micro\meter}, \SI{35}{\micro\meter}]]$\\
simpli.filter\_rotations & $\SIlist{0;20;40;60;80;100;120;140;160}{\degree}$\\
simpli.interpolate & \texttt{"Slerp"}\\
simpli.wavelength & $\SI{525}{\nano\meter}$\\
simpli.optical\_sigma & $\SI{0.75}{\pixel}$\\
tilt angle & $\SI{3.9}{\degree}$\\
simpli.light\_intensity & $\SI{8000}{}$\\
gain & \SI{0.1175}{}\\
simpli.noise\_model & \code{lambda x: np.floor(np.random.normal(x,}\\
 & \ \ \ \ \ \code{np.sqrt(gain * x))+0.5).astype(np.uint16)}\\
fiber absorption & rodent: $\SI{14}{\milli\meter\tothe{-1}}$, Vervet: $\SI{30}{\milli\meter\tothe{-1}}$, human: $\SI{60}{\milli\meter\tothe{-1}}$\\
fiber model & 'r'\\
fiber birefringence & 0.008\\
fiber radii & axon: \SI{0.75}{}, myelin: \SI{1}{}\\
model delta inclinations & single: $\SI{5}{\degree}$, crossings: $\SI{30}{\degree}$\\
model delta rotation & $\SI{15}{\degree}$\\
}
\label{tab:simParameters}
\end{table}
%
As described in \cref{chap:Software}, \ac{fastPLI} contains a pipeline implementation of the simulation with automatic analysis.
This implementation is used to compute the discretized volumes, simulate the signal, and apply the optical noise and tilting analysis to the resulting signal using the algorithm \ac{ROFL}. \footnote{source code is available in the appendix \dummy{}}.
This pipeline is used to simulate and analyze the \ac{3D-PLI} signal for the model library with different orientations of two crossing fiber populations.
\Cref{tab:simParameters} lists the parameters of the simulation in the variable notation of \ac{fastPLI}.
With a pixel size of \SI{1.3}{\micro\meter}, $\SI{2500}{\pixel}$ are available per simulation for statistical analysis.
The models are tilted in steps of $\Delta \modelInc = \SI{5}{\degree}$ for a single fiber population and by $\Delta \modelInc = \SI{30}{\degree}$ for crossing fiber populations. The latter are then also rotated around the first fiber population (see \cref{fig:twomodelpopdesign}).
Depending on the crossing angle \modelOmega{}, the step size is adjusted so that the spatial distance between two resulting rotations is close to $\Delta \modelRot = \SI{15}{\degree}$.
This ensures that the sphere is sampled reasonably equidistantly given the computation time (see \cref{subfig:sphere:histb}).
%
%
%
\subsection{Single inclined fiber population}
\label{sec:resSingleIncl}
%
\begin{figure}[!t]
\centering
\includegraphics[page=1]{dev/rc1/analysis/plots_single_pop_hist_output_cube_2pop_135_rc1_single.pdf}
\caption{Single inclined fiber population. Left: 2d log histogram of orientation from tilting analysis of simulation. Right: 2d log histogram of orientation from model segments.}
\label{fig:single_fiber_pop_hist}
\end{figure}
%
\begin{figure}[!p]
\centering
\includegraphics[]{dev/rc1/analysis/plots_single_pop_output_cube_2pop_135_rc1_single.pdf}
\caption{Single tilted fiber population. Results of the tilting analysis.}
\label{fig:single_fiber_pop_rofl}
\end{figure}
%
First, a single population of fibers is simulated and analyzed.
Since the direction is negligible for a single population, only the inclination parameter \modelInc{} remains.
\par
%
\Cref{fig:single_fiber_pop_hist} shows the orientation distribution of a single population of fibers for different inclinations $\modelInc{}$.
The distributions of the orientations of the model segments are shown on the left side, and those of the tilting analysis of the simulated images are shown on the right side.
The distributions are logarithmic and weighted by the area of the 2d binning.
The comparison between the two distributions shows the agreement of the tilting analysis with the model orientations for all inclinations.
\par
%
%Transmittance
\Cref{fig:single_fiber_pop_rofl} show the different modalities after analyzing the raw, non-tilted measurements.
The transmittance increases slightly with inclination angle for $\modelInc<\SI{75}{\degree}$.
For $\modelInc \ge \SI{75}{\degree}$ the transmittance increases significantly, \ie{} the absorption decreases.
The variance of transmittance is within a few percent for all inclinations and also increases slightly with inclination angle.
\par
%
% Retardation
The retardation plot shows the retardation of the non-tilted simulations and the theoretical curve that follows $(\cos(\modelInc) + 1) / 2 \cdot \mean(\mathrm{ret}(\SI{0}{\degree})$.
Normalization with $\mean(\mathrm{ret}(\SI{0}{\degree})$ ensures comparison with the data.
The retardation follows the theoretical line.
However, for the intermediate tilt angles, the measured retardation is slightly higher than the theoretical line.
Otherwise, the variance along all fiber inclinations is equal to \modelInc{}.
\par
%
% Direction
The next graph shows the measured direction.
For inclination angles smaller than $\SI{75}{\degree}$ the variance remains quite small.
For larger values, the variance increases.
It should be remembered that the boxplot does not take into account that the values are periodic.
Therefore, especially for $\modelInc=\SI{90}{\degree}$, the values from the $\SIrange{-90}{90}{\degree}$ are uniformly distributed.
\par
%
% Inclination
The inclination is drawn as a line, as well as the set angle of inclination.
The angles are shifted by the $\modelInc$ so that the admissible distribution values are in the range $[\modelInc-\SI{90}{\degree}, \modelInc+\SI{90}{\degree})$.
The median follows the theoretical curve.
For values above $\SI{75}{\degree}$ the variance increases again significantly, except for $\modelInc = \SI{90}{\degree}$ it is similar to the first values.
\par
%
% trel
The median relative birefringence thickness \trel{} is stable for values up to $\modelInc < \SI{60}{\degree}$, but the variance increases slightly.
For larger values, the median decreases while the variance increases.
Some outliers reach values $>\SI{1}{}$.
For inclination angles $\modelInc \ge \SI{85}{\degree}$, the quartile value $\SI{75}{\percent}$ increases by $\SI{1}{}$ and the median for $\SI{90}{\degree}$ reaches about $\SI{2}{}$.
\par
%
% domega
The opening angle \openingAngle{} is stable with a median of \dummy{} up to an inclination angle of $\le \SI{70}{\degree}$.
For higher inclination angles, both the median and the variance increase significantly, analogous to the inclination, except in the last case.
%
%
%
\subsection{Crossing flat fiber populations}
\label{sec:resCrossFlat}
%
\begin{figure}[!t]
\centering
\includegraphics[page=3]{dev/rc1/analysis/plots_flat_pop_hist_output_cube_2pop_135_rc1_flat.pdf}
\caption{Crossing flat fiber population: $\modelPsi=\SI{30}{\percent}$. Left: 2d log histogram orientation from rofl analysis of simulation. Right: 2d log histogram of model segment orientation.}
\label{fig:flat_03_fiber_pop_hist}
\end{figure}
%
\begin{figure}[!p]
\centering
\includegraphics[page=3]{dev/rc1/analysis/plots_flat_pop_output_cube_2pop_135_rc1_flat.pdf}
\caption{Crossing flat fiber population: $\modelPsi=\SI{30}{\percent}$. Tilting analysis results. \todo{domega, trel}}
\label{fig:flat_03_fiber_pop_rofl}
\end{figure}
%
\begin{figure}[!t]
\centering
\includegraphics[page=5]{dev/rc1/analysis/plots_flat_pop_hist_output_cube_2pop_135_rc1_flat.pdf}
\caption{Crossing flat fiber population: $\modelPsi=\SI{50}{\percent}$. Left: 2d log histogram of the orientation from the tilting analysis of the simulation, right: 2d log histogram of the orientation of the model segments.}
\label{fig:flat_05_fiber_pop_hist}
\end{figure}
%
\begin{figure}[!p]
\centering
\includegraphics[page=5]{dev/rc1/analysis/plots_flat_pop_output_cube_2pop_135_rc1_flat.pdf}
\caption{Crossing flat fiber population: $\modelPsi=\SI{50}{\percent}$. Tilting analysis results.}
\label{fig:flat_05_fiber_pop_rofl}
\end{figure}
%
The next simulation focuses on two flat crossing fiber populations.
Here, the results for the case $\modelPsi = \SI{30}{\percent}$ and $\modelPsi = \SI{50}{\percent}$ are examined.
The other proportions of the fiber population are available in \todo{appendix}.
\par
%
\ref{fig:flat_03_fiber_pop_hist} shows the distribution of orientation for the simulation and model fiber segments.
The resulting fiber orientation appears to follow only the second fiber orientation, which has a density of $\SI{70}{\percent}$.
However, the direction of the orientation from the simulation is not the same as that of the dominant fiber orientation.
In the case of $\modelPsi = \SI{50}{\percent}$, the signal orientation lies between the two single distributions, except in the case of $\modelOmega = \SI{90}{\degree}$, where mostly inclined resulting orientations are visible.
\par
% Transmittance
The transmittance increases with increasing crossing angle \modelOmega{}. The two \modelPsi shown have the same shape in both diagrams. In the case of $\modelPsi = \SI{30}{\percent}$ it reaches a transmittance of about \SI{1090}{} and in the case of $\modelPsi = \SI{50}{\percent}$ about \SI{1110}{}.
\par
% Retardation
The retardation appears to be strongly negatively linearly correlated with increasing crossing angle.
The linear curve drops to about $\SI{30}{}$ in the case of the first fiber population proportion and to about $\SI{0}{}$ in the case of the uniform distribution.
For both fiber population proportions, the variance increases visibly with the crossing angle.
\par
% Direction
The direction is plotted in the next graph with dotted lines for the direction of each fiber population.
In the case of $\modelPsi = \SI{30}{\percent}$, the direction follows the second fiber population, but there are slightly but significantly lower values in the central region.
In the case of $\modelPsi = \SI{50}{\percent}$, the values are exactly between the two fiber populations, with an exception for the last crossing angle $\modelOmega = \SI{90}{\degree}$, where the values are evenly distributed.
In both cases the analyed values follow the predicted circular mean value (dashed line).
\par
% Inclination
The inclination is about $\SI{0}{\degree}$ with its median for all crossing angles.
The variance increases significantly with increasing crossing angle, up to about $\SI{3}{}$ times the lowest value in the case of $\modelPsi = \SI{30}{\percent}$, and significantly more in the case of $\modelPsi = \SI{50}{\percent}$.
The inclination for the last crossing angle is almost uniformly distributed there.
\par
% Trel
The relative thickness \trel{} decreases with increasing crossing angle \modelOmega{}.
The shape of the curve correlates negatively with increasing crossing angle.
In both cases, the variance increases only very slightly.
The case $\modelPsi = \SI{50}{\percent}$ and $\modelOmega = \SI{90}{\degree}$ is the exception where the \trel{} values reach higher values, with many outliers also reaching values $>\SI{1}{}$.
\par
% domega
The opening angle \openingAngle{} is small in the first half of the crossing angle with a median of a few degrees, but the value increases slightly for larger crossing angles.
The same is true for the case $\modelPsi = \SI{50}{\percent}$, but the \openingAngle{} increases much more until for the $\modelOmega = \SI{90}{}$ the median is about $\SI{40}{\degree}$ with a high variance.
%
% 
%
\subsection{Inclined crossing fibers population}
\label{sec:resInclCross}
%
\begin{figure}[!t]
\centering
\includegraphics[page=3]{dev/rc1/analysis/plots_inclined_pop_hist_output_cube_2pop_135_rc1_inclined.pdf}
\caption{Population of inclined crossing fibers: $\modelPsi=\SI{30}{\percent}$. Left: 2d log histogram of orientation from tilting analysis of simulation, right: 2d log histogram of orientation of model segments.}
\label{fig:inclined_03_fiber_pop_hist}
\end{figure}
%
\begin{figure}[!p]
\centering
\includegraphics[page=3]{dev/rc1/analysis/plots_inclined_pop_output_cube_2pop_135_rc1_inclined.pdf}
\caption{Population of inclined crossing fibers: $\modelPsi=\SI{30}{\percent}$. Results of tilting analysis.}
\label{fig:inclined_03_fiber_pop_rofl}
\end{figure}
%
\begin{figure}[!t]
\centering
\includegraphics[page=5]{dev/rc1/analysis/plots_inclined_pop_hist_output_cube_2pop_135_rc1_inclined.pdf}
\caption{Population of inclined crossing fibers: $\modelPsi=\SI{50}{\percent}$. left: 2d log histogram of orientation from tilting analysis of simulation, right: 2d log histogram of orientation of model segments.}
\label{fig:inclined_05_fiber_pop_hist}
\end{figure}
%
\begin{figure}[!p]
\centering
\includegraphics[page=5]{dev/rc1/analysis/plots_inclined_pop_output_cube_2pop_135_rc1_inclined.pdf}
\caption{Population of inclined crossing fibers: $\modelPsi=\SI{50}{\percent}$. Results of tilting analysis.}
\label{fig:inclined_05_fiber_pop_rofl}
\end{figure}
%
Next, we are concerned with two crossing fiber bundles with a rotation angle of $\modelRot = \SI{90}{\degree}$, \ie{} the first fiber population along the $x$-axis and the second population in the $xz$-axis.
As before, the two parameters $\modelPsi = \SI{30}{\percent}$ and $\modelPsi = \SI{50}{\percent}$ are discussed.
The other fiber percentages are listed in the \todo{appendix}.
\par
%
The histogram data for both cases show only visible orientation for the measurement.
\dummy{}.
\par
% Transmittance
The transmittance is almost identical in both cases.
It increases with increasing crossing angle, but the inclination decreases for larger $\modelOmega$.
The median increases to a value of $\SI{110}{\percent}$ in both cases as opposed to the flat case.
The variance remains similar for all values.
\par
% Retardation
In both cases, the retardation decreases almost linearly with increasing crossing angle $\modelOmega$.
In the case of $\modelPsi = \SI{30}{\percent}$, the final value is about $\SI{0.18}{}$ in contrast to $\modelPsi = \SI{50}{\percent}$ with a final value of $\SI{0.3}{}$.
The variance increases significantly for larger crossing angles.
\par
% Direction
The directional value is again very similar in both cases.
The median is always around $\SI{0}{\degree}$.
The quartile grows from about $\SI{0.5}{\degree}$ to $\SI{2}{\degree}$ with increasing crossing angle.
\par
% Inclination
In the case of $\modelPsi = \SI{30}{\percent}$, the inclination is almost linear with increasing crossing angle from about $\modelOmega =\SI{60}{\degree}$.
In the case of $\modelPsi = \SI{50}{\percent}$, the peak value is at about $\modelOmega = \SI{60}{\degree}$.
The variance increases for both parameters as the crossing angle increases.
The main difference between the two parameters is that in the case of $\modelPsi = \SI{30}{\percent}$, the maximum inclination achieved is significantly higher than in the case of $\modelPsi = \SI{50}{\percent}$.
In both cases, however, the inclination only follows the circular mean value (dashed line) vor the lower crossing values.
\par
% Trel
The relative effective thickness \trel{} decreases in both cases.
In the case of $\modelPsi = \SI{50}{\percent}$, the correlation is nearly linear and the variance increases slightly with increasing crossing angle.
In the case of $\modelPsi = \SI{30}{\percent}$, a small hill is visible around $\modelOmega = \SI{50}{\degree}$ where the value and variance increase slightly.
\par
% domega
Both the opening angle and its variance appear to increase exponentially with increasing crossing angle in the case of $\modelPsi = \SI{30}{\percent}$.
In the case of $\modelPsi = \SI{50}{\percent}$, both the median and variance also increase, but the increase in the largest crossing values stops at a median of about $\SI{6}{\degree}$.
%
\subsection{Free crossing fiber populations}
\label{sec:resFreeCross}
%
The following data shows the result of the tilting analysis without the orientation angles, because the mean value for a single angle cannot be calculated easily. \footnote{Orientations lie on a hemisphere with symmetries, and angles are interdependent}
The data from the previous chapter had the advantage that the results of the angles are close enough to each other to make a conversion to the expected value.
\par
%
The spherical plots in \cref{fig:sim_ana_acc,fig:sim_ana_ret,fig:sim_ana_trans,fig:sim_ana_trel} are designed so that the thick black circle shows the orientation of the first fiber population and the thin dashed circles show the orientation of the second fiber population.
At the position of the second fiber population, the resulting mean value is inserted.
%
%
%
\begin{figure}[!p]
\centering
\includegraphics[]{dev/rc1/analysis/simulation_analysis_hist_0.5_setup_PM_s_Vervet_m_r_acc.pdf}
\caption{Mean \ac{ACC} value between model and tilting analysis orientations. \todo{x,y labels}}
\label{fig:sim_ana_acc}
\end{figure}
%
\paragraph{\acs{ACC}}
\Cref{fig:sim_ana_acc} shows the \acreset{ACC} \ac{ACC} value, \ie{} how well the coefficients of the \ac{ODF} basis function are matched.
\todo{acc of psi = 1}.
The $\modelPsi=\SI{10}{\percent}$ show no significant reduction in the \ac{ACC} value for all $\modelInc$.
The most secondarily inclined values for $\modelPsi=\SI{30}{\percent}$ have a significant decrease in the \ac{ACC} value.
This is much less visible for the case $\modelInc = \SI{30}{\degree}$ and even less for the case $\modelInc = \SI{60}{\degree}$.
The $\modelInc = \SI{90}{\degree}$ is less than for the case $\modelPsi=\SI{10}{\percent}$, but still constant for all secondary orientations.
\par
%
For the equally proportional fiber population $\modelInc = \SI{50}{\degree}$, the \ac{ACC} value reaches its lowest values at the shallowly inclined first population $\modelInc = \SIlist{0;30}{\degree}$.
In the case of $\modelInc = \SI{0}{\degree}$, the \ac{ACC} value is lowest at a crossing angle of $\modelOmega = \SI{90}{\degree}$.
This crossing angle for the slightly inclined has a higher \ac{ACC} value \todo{why?, -> show odf}.
Otherwise, the distribution is similar with respect to 3d orientation symmetry.
The most inclined angle $\modelInc=\SI{90}{\degree}$ shows an \ac{ACC} value of about $\SI{0.5}{}$ for all orientations with an increase to $\SI{1}{}$ for the $\modelOmega = \SI{0}{\degree}$ ,\ie{} a single fiber population along the z-axis.
\par
%
The data for $\modelPsi=\SI{70}{\percent}$ show the same behavior in terms of inclined rotation for the first two inclination angles $\modelInc = \SIlist{0;30}{\degree}$.
For the case $\modelInc=\SI{60}{\degree}$, the \ac{ACC} value is high only for the first fiber population.
In the case of $\modelInc=\SI{90}{\degree}$ this is also visible, but the smallest values are not as low as in the previous case.
\par
%
The last case $\modelPsi=\SI{90}{\percent}$ shows a good agreement of the orientation coefficients of the model with the analyzed signal for the first three inclination angles $\modelInc=\SIlist{0;30;60}{\percent}$.
The last inclination angle $\modelInc=\SI{90}{\degree}$ shows a decrease of the \ac{ACC} value for the highest crossing angles $\modelOmega$.
%
%
%
\begin{figure}[!p]
\centering
\includegraphics[]{dev/rc1/analysis/simulation_analysis_hist_0.5_setup_PM_s_Vervet_m_r_ret_mean.pdf}
\caption{Mean retardation values. \todo{x,y labels}}
\label{fig:sim_ana_ret}
\end{figure}
%
\paragraph{Retardation}
The retardation results in \cref{fig:sim_ana_ret} show the least retardation for an inclination angle of $\alpha=\SI{90}{\degree}$ for the second fiber population in the case of the smallest first fiber population fraction $\modelPsi=\SI{10}{\percent}$ and an increase to the flat case of $\alpha=\SI{0}{\degree}$.
\par
%
This is also visible for the second case of $\modelPsi=\SI{30}{\percent}$ and $\modelPsi=\SI{60}{\percent}$, however, for the first two $\modelInc = \SIlist{0;30}{\degree}$ the non-crossing fiber populations have significantly higher retardation.
For higher $\modelInc$, the values decrease overall, and a reduction in crossing is no longer visible.
\par
%
In the case of $\modelPsi=\SI{60}{\percent}$, the retardation is very similar to the previous case $\modelPsi=\SI{30}{\percent}$, but the value is much lower.
\par
%
In the case $\modelPsi=\SI{70}{\percent}$, an increase in retardation is again observed at the first two crossing angles $\modelInc=\SIlist{0;30}{\degree}$ in contrast to the previous values.
A decrease in retardation at the highest crossing angles is still visible, but relatively small compared to the previous values.
The last two crossing angles $\modelInc=\SIlist{60;90}{\degree}$ are significantly lower.
\par
%
The last case of $\modelPsi=\SI{90}{\percent}$ shows a decrease in retardation with inclination angle $\modelInc$.
The second fiber population orientation of has almost no effect on the results.
%
%
%
\begin{figure}[!p]
\centering
\includegraphics[]{dev/rc1/analysis/simulation_analysis_hist_0.5_setup_PM_s_Vervet_m_r_trans_mean.pdf}
\caption{Mean transmittance value. \todo{x,y labels}}
\label{fig:sim_ana_trans}
\end{figure}
%
\paragraph{Transmittance}
The average transmission value is given in \cref{fig:sim_ana_trans}.
The fraction of the first fiber population of $\modelPsi=\SI{10}{\percent}$ is almost identical for all inclination angles $\modelInc$.
The main difference is that the transmittance is lowest for models with a crossing angle of $\modelOmega = \SI{0}{\degree}$.
Otherwise, the transmittance remains relatively constant low.
\par
%
This changes a little for the next fiber population fraction of $\modelPsi=\SI{30}{\percent}$.
Again, the transmittance is lowest at no crossing angle, but the increase in value is more pronounced than in the previous case.
\par
%
In the next case of $\modelPsi=\SI{50}{\percent}$ the effect is even stronger.
Nevertheless, the transmittance is lowest at no crossing angle.
\par
%
The last two cases $\modelPsi=\SI{70}{\percent}$ and $\modelPsi=\SI{90}{\percent}$ are identical to the cases $\modelPsi=\SI{30}{\percent}$ and $\modelPsi=\SI{10}{\percent}$.
%
%
%
\begin{figure}[!p]
\centering
\includegraphics[]{dev/rc1/analysis/simulation_analysis_hist_0.5_setup_PM_s_Vervet_m_r_rtrel_mean.pdf}
\caption{Mean \trel{} from tilting analysis. \todo{x,y labels}}
\label{fig:sim_ana_trel}
\end{figure}
%
\paragraph{\trel}
The results of \trel{} are shown in \cref{fig:sim_ana_trel}.
All values correlate almost perfectly with retardation.
The only significant difference is that the \trel{} value is significantly higher than $\SI{1}{}$.
It should be noted that the upper limit of the color bar was reduced to $\SI{1}{}$ to make the distribution more visible.
In the cases of $\trel > \SI{1}{}$, the retardation values are the smallest.
Here the interpolation of the spherical background values should not be taken too seriously.
%
%
%
\begin{figure}[!p]
\centering
\includegraphics[]{dev/rc1/analysis/simulation_analysis_hist_0.5_setup_PM_s_Vervet_m_r_R.pdf}
\caption{Mean \rvalue{} from tilting analysis. \todo{x,y labels}}
\label{fig:sim_ana_rvalue}
\end{figure}
%
\paragraph{\rvalue}
The last value is the \rvalue{} (see \cref{fig:sim_ana_rvalue}).
It describes the mean absolute difference between the data and the fitted data from the tilting analysis.
Its value is overall in the range of $\SIrange{1.2}{1.8}{\percent}$.
For $\modelInc = \SI{0}{\degree}$, the \rvalue{} increases in the middle of the polar diagram for higher \modelPsi{} values.
The $\modelInc = \SI{30}{\degree}$ show towards the $\modelPsi = \SI{50}{\percent}$ a curved pattern with slightly higher \rvalue{}.
For higher $\modelPsi$ the pattern changes and only the centered area is enlarged.
For $\modelInc = \SI{60}{\degree}$, an increase in \rvalue{} towards the outer regions is visible.
As \modelInc{} increases, the pattern also changes and becomes increasingly visible up to $\modelPsi=\SI{70}{\percent}$ in the upper and lower parts of the polar diagram.
Finally, for the case $\modelInc = \SI{90}{\degree}$, the \rvalue s are low again.
\par
%
A significant difference has the $\modelPsi = \SI{10}{\percent} / \modelInc = \SI{90}{\degree}$.
Here, the values for the crossing angles to $\modelOmega = \SI{90}{\degree}$ reach a higher value of $\approx \SI{2.2}{\percent}$.
The \rvalue{} for higher proportions of the first fiber population $\modelPsi$ at this inclination angle $\modelInc$ has a similar pattern, but becomes lower and lower for higher $\modelPsi$.
%
%
%
%
\subsection{Speedup}
\label{sec:simSpeedup}
% \tikzset{external/force remake=true}
% \tikzset{external/export=false}
%
% MPI
\begin{figure}[!t]
\centering
%
\begin{lrbox}{\newtable}
\pgfplotstabletypeset[%
    thesisTableStyle,
    column type=l,
    fixed, zerofill, precision=2,
    dec sep align,
    font={\scriptsize},
    columns/cpus/.style={precision=0},
    % columns/value/.style={string type},
]
{cpus mean std
1	1.00006472390261	0.008436755542444
2	1.92269431841134	0.013489117814521
3	2.96577613197067	0.026032692317656
4	3.7772210840161	    0.0683451109519
5	4.69310330928019	0.053307326948835
6	5.59568645873564	0.08209457262756
7	6.46527803633867	0.078755238845452
8	6.77988547696095	0.070937664466063
16	13.2706748124183	0.227421225827763
24	17.2977004181403	0.356822695290338
32	21.6900417343156	0.489742257920109
40	25.4634907689925	0.543172079794108
48	27.9281802113992	0.714407306509344
}
\end{lrbox}
%
\begin{tabular}{cc}
\begin{minipage}{0.6\textwidth}
\includegraphics[page=2]{dev/rc1/speed/boxplot_generation_output_generation_mpi_v_0.1.csv.pdf}
\end{minipage}
&
\begin{minipage}{0.25\textwidth}
\usebox{\newtable}
\end{minipage}
\end{tabular}
\caption{\ac{MPI} speedup discrete tissue generation mean time $\SI{1}{\core}$: 29.9 +- 0.2 \todo{sekunden?}}
\label{fig:speedTissueMPI}
\end{figure}
%
\begin{figure}[!t]
\centering
\begin{lrbox}{\newtable}
\pgfplotstabletypeset[%
    thesisTableStyle,
    column type=l,
    fixed, zerofill, precision=2,
    dec sep align,
    font={\scriptsize},
    columns/cpus/.style={precision=0},
    % columns/value/.style={string type},
]
{cpus mean std
1	1.00028560723869	0.016748523109448
2	1.89554114187235	0.061890791019146
3	2.93217274657456	0.137044706938191
4	3.80796194148021	0.151338179581496
5	4.56797840123376	0.294743030055688
6	5.46464911530043	0.244860209863609
7	6.30306494349277	0.558808919534342
8	7.22964159473554	0.370613450811933
16	13.6057964309241	0.869296236931105
24	19.9354473052936	0.76053214292035
32	25.4688807363332	1.33524999091616
40	30.3887245939769	2.98878482975798
48	34.7093030892855	3.59570044944364
}
\end{lrbox}
%
\begin{tabular}{cc}
\begin{minipage}{0.6\textwidth}
\includegraphics[page=2]{dev/rc1/speed/boxplot_simulation_output_simulation_mpi_v_0.1.csv.pdf}
\end{minipage}
&
\begin{minipage}{0.25\textwidth}
\usebox{\newtable}
\end{minipage}
\end{tabular}
\caption{\ac{MPI} speedup simulation including all five tilt direction. Mean time $\SI{1}{\core}$, centered: 80 +- 2 \todo{sekunden?}}
\label{fig:speedSimMPI}
\end{figure}
%
%
% OPENMP
\begin{figure}[!t]
\centering
%
\begin{lrbox}{\newtable}
\pgfplotstabletypeset[%
    thesisTableStyle,
    column type=l,
    fixed, zerofill, precision=2,
    dec sep align,
    font={\scriptsize},
    columns/cpus/.style={precision=0},
    % columns/value/.style={string type},
]
{cpus mean std
1	1.00003318870801	0.006043762665602
2	1.34745571509197	0.112126679306381
3	1.85706837136119	0.166855662031889
4	2.07043347980059	0.203474087892324
5	2.41719826573049	0.208307641301249
6	2.67381650473413	0.144163042046179
7	2.81024536424621	0.413899849287807
8	3.05678368352906	0.238570289478912
16	3.98524630106596	0.175099042780921
24	4.64005306796557	0.118496100940545
32	4.90099710152266	0.112188961625372
40	4.89783195844876	0.528173540658736
48	5.22901104444621	0.053589607722899
}
\end{lrbox}
%
\begin{tabular}{cc}
\begin{minipage}{0.6\textwidth}
\includegraphics[page=2]{dev/rc1/speed/boxplot_generation_output_generation_mp_v_0.1.csv.pdf}
\end{minipage}
&
\begin{minipage}{0.25\textwidth}
\usebox{\newtable}
\end{minipage}
\end{tabular}
\caption{\ac{OpenMP} speedup discrete tissue generation. Mean time 1 cpu: 29.9 +- 0.2}
\label{fig:speedTissueMP}
\end{figure}
%
\begin{figure}[!t]
\centering
%
\begin{lrbox}{\newtable}
\pgfplotstabletypeset[%
    thesisTableStyle,
    column type=l,
    fixed, zerofill, precision=2,
    dec sep align,
    font={\scriptsize},
    columns/cpus/.style={precision=0},
    % columns/value/.style={string type},
]
{cpus mean std
1	1.00026069793854	0.015929466416549
2	1.95547220178774	0.065680726218777
3	2.97138856408045	0.080728713321266
4	3.90097732250136	0.154778304333818
5	4.89979040078024	0.193465065920687
6	5.81536649890996	0.125590793795792
7	6.71229347977858	0.143352506525363
8	7.57827799547624	0.369746017663724
16	14.6032840374081	0.31614387537932
24	21.6206614940094	1.91501760949786
32	28.8271369113821	1.12327525256459
40	35.6305514268905	1.51516739583375
48	42.1637558599282	1.30733435281682
}
\end{lrbox}
%
\begin{tabular}{cc}
\begin{minipage}{0.6\textwidth}
\includegraphics[page=2]{dev/rc1/speed/boxplot_simulation_output_simulation_mp_v_0.1.csv.pdf}
\end{minipage}
&
\begin{minipage}{0.25\textwidth}
\usebox{\newtable}
\end{minipage}
\end{tabular}
\caption{\ac{OpenMP} speedup simulation for 5 tilt direction. Mean time 1 cpu, centered: 74.9 +- 0.2}
\label{fig:speedSimMP}
\end{figure}
%
Simulations were performed using a single compute node (\texttt{2x Intel(R) Xeon(R) CPU E5-4657L v2}).
\par
%
Four speedup measurements are shown in \cref{fig:speedTissueMPI,fig:speedSimMPI} for parallelization \ac{MPI} and \cref{fig:speedTissueMP,fig:speedSimMP} for parallelization \ac{OpenMP}.
To measure speedup, each algorithm was run $N=10$ times.
To calculate the speedup value, the mean measured time for $n_\mathit{cpu}=1$ was then divided by the measured time for the $n_\mathit{cpu}$ individual values.
The volume used is the $\modelPsi=\SI{0}{\percent} / \modelInc=\SI{0}{\degree}$ from the \cref{sec:simParameterEnv} parameterization.
\par
%
The \cref{fig:speedTissueMPI} shows the parallelization of the discrete tissue generation (see \cref{sec:dv_generator}).
The speedup for $\SI{8}{\cores}$ is about $\SI{6.8}{}$ and for $\SI{48}{\cores}$ about $\SI{30}{}$ for this architecture.
For the simulation \cref{fig:speedSimMPI}, it is similar with a speedup for $\SI{8}{\cores}$ around $\SI{7.2}{}$ and for $\SI{48}{\cores}$ around $\SI{35}{}$.
The graph shows the speedup values for the different tilt angles.
The centered $(C)$ position has a significantly higher speedup than the tilt angles.
\par
%
The \ac{OpenMP} speedup for tissue generation is significantly lower than in the \ac{MPI} case.
The speedup reaches a value of $\SI{3}{}$ for $\SI{8}{\cores}$ and $\SI{5.23}{}$ for $\SI{48}{\cores}$.
The speed increase is almost linear for all \acp{CPU} tested.
\par
%
For simulation speedup, the values are similar to the case of \ac{MPI}.
Up to $\SI{8}{\cores}$, the speedup is almost identical and ideal.
However, for a larger number of \acsp{CPU}, the speedup is higher at $\SI{42}{}$ for $\SI{48}{\cores}$.
%
% 
%
\section{Discussion}
%
\subsection{Single inclined fiber population}
\Cref{sec:resSingleIncl} shows the results for the case of a single fiber population with inclined configurations.
The transmittance values show an increase for the last free inclination values.
This is to be expected since the 3D model configurations are aligned in parallel along an axis with some randomness.
When this axis is aligned along the z-axis, \ie{} $\modelInc=\SI{90}{\degree}$, the light rays, which also travel along the z-axis, statistically strike less tissue, so the transmittance must increase.
Since the density of the tissue is quite high, the effect is only a few percent.
In reality, however, one must take into account that \cite{Menzel2021}\todo{check ref} could show that the change in transmittance is much more complicated.
One of the most important effects is the significant change of transmittance with inclination.
The effect on the results presented here is an increase/decrease in noise depending on \cref{fig:parameterModelGain}.
However, since the change in noise is linear with the square root of the intensity, the effect is rather small.
\par
%
The retardation almost follows the theoretical curve for a single retardation signal (see \cref{eq:pli_signal}).
However, the signal for the mean values is higher than the theoretically expected values.
One must remember that the theoretical signal is normalized by the maximum value of the retardation, \ie{} the value for $\modelInc = \SI{0}{\degree}$.
However, this value is incorrect in that the inclination angle of the underlying fibers is not perfectly $\SI{0}{\degree}$. The opening angle of the models is about \dummy{}.
Therefore, the normalization is set too low, and this is also true for the theoretical curve.
\dummy{}.
%
The direction values have a very small variance, which increases strongly at high inclination values.
Since the direction value is coupled to the inclination angle, there is no xy direction for an $\SI{90}{\degree}$ inclined orientation, as expected.
\par
%
The same behavior can be observed for the inclination curve.
However, here the variance for the last angle is lower.
It should be noted that the change in the signal that fits the tilting analysis is the same for the non-inclined measurement as for the four inclined measurements.
Therefore, one possibility is that the signal change is higher because the fibers are in their most extreme position here than in a slightly less inclined case.
\par
%
The \trel{} value also follows the theoretical behavior up to the last value.
For smaller \trel{} values, the algorithm is able to explain the signal.
For larger \trel{} values, however, the optimization fitting algorithm tries to find unphysical solutions that are mathematically better.
This behavior could be constrained by a maximum \trel{} value of one in the optimizer, but in this way it becomes clearer that the resulting orientation cannot be trusted.
This is true for the experimental tissue measurements, since there are many more effects than in this simulation.
However, for this simulation, the inclination results indicate that it is still possible for the algorithm to find a feasible \trel{} value that is very small.
Since \trel{} is the effective thickness of the parallel optical axis model, this value for inclined fiber configurations should theoretically be $\SI{0}{}$ for $\modelInc=\SI{90}{\degree}$.
\par
%
As expected, the opening angle shows the combined information from the direction results and the inclination results.
The inclination values $\modelInc <= \SI{75}{\degree}$ show an orientation distribution of \dummy{} with some outliers.
This value can perhaps serve as an additional uncertainty for further computations as in a tractography.
However, this would be a lower bound on the uncertainty since the effects of light scattering are not considered in this simulation.
\par
%
In the case of a single fiber population, the resulting tilting analysis shows good agreement with the individual orientations of the model, except for very steeply inclined configurations.
%
\subsection{Crossing flat fiber population}
\Cref{sec:resCrossFlat} shows the results of the flat crossing configurations.
The transmittance value changes significantly with increasing \modelOmega{}, which is to be expected since crossing models require more space.
Therefore, in a narrow volume, fewer fibers, \ie{} fewer tissues, can absorb light, and therefore the transmittance value must increase.
This also explains the slowing of the value at larger crossing angles, since here the layered structure already \todo{?} sop ports similar crossing angles.
Otherwise, the fibers would have to cross the volume in a more complicated way, which would be less effective.
\par
%
The retardation follows an almost linear decrease for the presented fiber fraction populations \modelPsi{}.
Since the retardation effect of is cancelled by a $\SI{90}{\degree}$ retarder, this effect is as expected.
The last value for the retardation agrees with the theoretical residual $\approx 0.8\cdot \SI{40}{\degree}$.
However, its values are slightly but significantly lower for the mean \trel{} values.
In the case of $\modelPsi{} = \SI{50}{\percent}$, they follow the midline between the two directions until $\modelOmega=\SI{90}{\degree}$, where the retardation is effectively $\SI{0}{}$ and therefore no direction can be identified.
\par
%
The effect of a change of direction results from \dummy{}.
Since the optical axis is an orientation and not a vector, the signal is cancelled in the case of $\SI{90}{\degree}$.
Lower values must therefore drive the resulting phase of the sinusoidal signal in the direction of the lower represented fiber bundle, which must be maximum at $\modelOmega=\SI{45}{\degree}$.
In both cases the predicting circular mean value is fullfilled.
This is also true for the other fiber fractions (\todo{see appendix})
\par
%
The variance of the inclination angle increases with increasing \modelOmega{}, which is to be expected as the amplitude, \ie{} the retardation decreases, making the model more uncertain.
In the case of a uniformly distributed fiber crossing, the inclination can reach any value since there is no longer any effective retardation.
\par
%
This can also be seen in the decreasing value of \trel{}.
As expected, the decrease is linear when the signal becomes \dummy{}.
For the uniformly distributed transition, the tilting analysis again reaches values of $\trel>1$.
\par
%
The effects described above are reflected in the opening angle \openingAngle{}, which must increase with increasing \modelOmega{}.
%
%
%
\subsection{Inclined crossing fiber population}
\Cref{sec:resInclCross} shows the results for the inclined crossing fiber population, \ie{} $\modelRot=\SI{90}{\degree}$.
With the exception of inclination, the results are very similar to the previous case of the flat crossing fiber population.
This is to be expected since inclined fibers do not contribute to retardation.
The inclination in the case of $\modelPsi=\SI{30}{\percent}$ initially increases as the main fiber population, \ie{} the second, contributes more to retardation until eventually the median falls back to $\SI{0}{\degree}$.
In the case of $\modelPsi=\SI{50}{\degree}$, the tipping point is earlier and lower because the second nerve fiber bundle contributes less.
The circular mean value is only followed for lower crossing angles.
For larger values the measured inclinations deviate from the theoretical line since the inclined nerve fibers contribute less to the overall signal and cannot anymore deteced.
For large fiber population fractions (\todo{see ...}) where the flat fiber population has a lower influence, the circular mean value applies also for larger crossing angles.
Otherwise, the other parameters do not behave differently with respect to the reduced signal and its effects than in the case of the single fiber population.
%
%
%
\subsection{Free crossing fiber population}
\Cref{sec:resFreeCross} shows the results of the \ac{ACC} and other parameters for the free crossing fiber population.
The \ac{ACC} parameter, which is a measure of the agreement of the \ac{ODF} coefficient, is a key parameter for highlighting problematic orientations of the fiber population.
However, the value itself is not easy to interpret.
\par
%
From \ref{fig:sim_ana_acc}, a range of low \modelPsi{} and low \modelInc{} to higher low \modelPsi{} and higher \modelInc{} is evident where the \ac{ACC} is significantly low, with larger areas near $\SI{0}{}$.
These areas correspond to the known problematic areas in intersections and inclined regions.
However, these results give a better idea of how strong the indication is with respect to the \ac{ACC} value.
The \ac{ACC} value can potentially be used as a weight for \todo{not ...}.
An important result is the correlation between the \ac{ACC} value and the \trel{} value.
As the \trel{} value is analyzed, it can be used as an indicator of an underlying intersection or oblique region.
This would then also be an indicator for further data processing \eg{} a tractography.
Note that these results are only valid for dense fiber populations, \ie{} dense white matter.
\par
%
Retardation is also an indicator, but not as reliable, since its value is very low even for a single inclined fiber population, which can still be correctly determined with a high variance using tilting analysis (see \cref{fig:single_fiber_pop_rofl}).
There, too, the \trel{} value is reduced, but not as much as in the crossing fiber populations.
This effect results from the simple fact that an inclined single fiber population increases its retardation value when tilted, while a flat crossing population does not due to signal cancellation.
\par
%
The relatively low \rvalue{} is consistent with the noise of \SI{14.3}{\percent} (see \cref{fig:noiseplot}).
The elevated patterns of \rvalue{} represent the range of a $\modelOmega \approx \SI{90}{\degree}$, where lower retardation is thus expected.
The most interesting pattern is for the case $\modelPsi = \SI{90}{\percent}$, where the \rvalue{} for the $\modelInc = \SI{0}{\degree}$ is maximum at a $\alpha_1$ \todo{check variable name} angle of $\SI{80}{\degree}$.
This is quite unexpected, since here the dominant nerve fiber population is the first one, \ie{} $\SI{90}{\percent}$.
Nevertheless, the small fraction of $\SI{10}{\percent}$ for a high inclination case seems to be sufficient to perturb the fitting algorithm based only on a single fiber population.
However, compared to the other results at this orientation, the other parameters do not appear to be perturbed in their mean values.
%
%
%
\subsection{Speedup}
%
The simulation algorithm speedup results presented in \cref{fig:speedTissueMPI,fig:speedSimMPI,fig:speedTissueMP,fig:speedSimMP} show very good speedup with increasing \ac{CPU} count, except for the \ac{OpenMP} case for the tissue generation algorithm.
Since in this case the \acsp{CPU} must write to the same memory in parallel, but not to the same memory address (see \cref{sec:dvOpti}), the overhead seems to slow down the algorithm quite a bit.
The results show that no more than $\SI{4}{\cores}$ is necessary, otherwise too much \dummy{} is lost.
However, since the \ac{MPI} implementation is quite good, the algorithm should be sped up over this implementation if needed.
\par
%
The simulation, on the other hand, has a very good speedup to $\SI{48}{\cores}$ for both the \ac{MPI} and the \ac{OpenMP}.
The \ac{OpenMP} is even stronger here.
This is the case because the \ac{OpenMP} implementation does not need to communicate with each other, and since the rest of the memory accesses are random anyway, the light beams can be ideally parallized.
The same is true for the \ac{MPI} implementation, except for the tilted case.
Since the volume is shared here, the light rays must be communicated, which takes time.
Therefore, the speed increase is lower here.
\par
%
Since the mesh generation algorithm is quite fast overall ($\SI{30}{\second}$) compared to the simulation ($\SI{80}{\second}$), which usually requires five times as much for the $\SI{4}{}$ additional tilt angles, the letter algorithm is the bottleneck anyway.
Therefore, the user can use both implementations to significantly improve the overall speed of the calculations.