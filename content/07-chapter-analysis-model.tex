\setcounter{chapter}{6}
\chapter{Dense \acs{WM} modelling analysis}
\label{cha:model_analysis}
% 
\todo{veroffentlichung in intro}
% 
\itodo{reproduzieren von modellen}
% 
\section{Introduction}
% 
After describing the functionality of the \pymodule{fastpli.model}, the next task is to use these methods not only to create realistic dense \ac{WM} models, but to keep them as simple as possible due to the complexity of the tissue.
This is due to the fact that \ac{WM} contains individual nerve fibers that typically have a size in the order of about $\SI{1}{\micro\meter}$.
Therefore, in a \SI{60}{\micro\meter} voxel of a \ac{LAP} measured \ac{3D-PLI} can be image within the \ac{WM} several thousand individual nerve fibers are already present.
Considering that each nerve fiber has a unique trajectory through this volume, this means that theoretically an absurd variety of possible configurations exists.
However, due to the nature of the \ac{3D-PLI} structure, previous studies have shown that the result of the signal depends on much less degrees of freedom than each individual nerve fiber has.
\\[\baselineskip]
% 
Therefore, this work, being the first study of its kind, focuses mainly on two randomly interwoven fiber populations for \ac{3D-PLI} simulations.
Another focus is the generation of such models, whereby the computational time effort shall be kept as low as possible.
The analysis refers to the setting of the parameters for the model generation and their influence on the resulting collision-free configurations.
% 
% 
\section{Brain tissue model}
% 
To create universal reusable \ac{WM} tissue models, a practical approach is to reduce the number of parameters to a minimum.
The approach chosen here is to build cubic volumes of up to two fiber populations with individual characterization.
The most important parameter for \ac{3D-PLI} is orientation.
% 
\subsection{single fiber bundle population}
% 
A single fiber bundle population can have any orientation $O(\varphi,\alpha)$ in 3d space.
However, since $O(\varphi,\alpha) = O(\varphi+\pi,-\alpha)$ only the orientations of a hemisphere are required.
Furthermore, the experimental setup does not allow a difference between a fiber bundle population with $\varphi = \varphi_0$ and $\varphi = \varphi_1$ when the initial optical elements are rotated by $\varphi_1-\varphi_0$, unless one considers the effect of the physical expansion of the camera pixels, which is neglected here.
Therefore it is not necessary to create a single fiber population with a direction other than $\varphi = \SI{0}{\degree}$.
However, the inclination must be sampled in the range of $[0,90]\si{\degree}$.
Since the fiber bundle populations can easily be rotate from $\varphi=\SI{0}{\degree}, \alpha=\SI{0}{\degree}$ to $\varphi=\varphi_{\text{target}}, \alpha=\alpha_{\text{target}}$, it is not necessary to create individual fiber bundle configurations.
\\
%
\paragraph{fiber distribution}
To initialize the trajectories the previous introduced method for building a cubic volume is be used (see \cref{sec:cubeModelBuilding}) along the fiber bundle population orientation $F = O(\varphi, \alpha)$.
The seeding along the fiber bundle population will be randomly set with:
\begin{align}
p = \mathrm{sample}\left(\mathrm{Uniform}(\sqrt{3}*\mathit{cube\_size})\right)
\end{align}
Each fiber will have an individual radii, sampled from a \name{log normal} distribution $\mathrm{LogNorm(
\mu,\sigma)}$ (see \cref{fig:logNormal}).
Its probability desity function looks like this:
\begin{align}
\mathrm{LogNorm}(x,\mu,\sigma)=\frac{1}{\sigma x \sqrt{2\pi}}\exp\left(-\frac{(\ln(x)-\mu)^2}{2 \sigma^2}\right)
\end{align}
% 
Its property allows to multiply by a logarithmic mean value $\fiberRadiusMu=0$ to sample values which are not allowed to have negative values like a length and keeping the desired mean value $\fiberRadiusMean$:
\begin{align}
\fiberRadius = \fiberRadiusMean \cdot \mathrm{sample}\left(\mathrm{LogNorm}(\mu=0,\sigma=0.1)\right)
\end{align}
% 
\begin{figure}[!t]
\centering
\tikzset{external/export=false}
\begin{tikzpicture}[scale=1, trim axis left, trim axis right]
\begin{axis}[height=0.46\textwidth, width=0.75\textwidth,enlargelimits=false, xlabel={$x$}, ylabel={$f(x,\mu,\sigma)$}, title=${f(x,\mu,\sigma)=\frac{1}{\sigma x \sqrt{2\pi}}\exp\left(-\frac{(\ln(x)-\mu)^2}{2 \sigma^2}\right)}$,
legend style={at={(1,1)},anchor=north east},
legend cell align={left},
]
\pgfmathsetmacro{\muValue}{0}
\pgfmathsetmacro{\sigmaValue}{0.05}
\addplot[BLUE,thick,domain=0.6:1.4, samples=2*42, smooth]{1/(\sigmaValue*x*sqrt(2*pi))*exp(-(ln(x)-\muValue)^2/(2*\sigmaValue^2))}; \addlegendentry{$\mu=0.0,\sigma=0.05$}
\pgfmathsetmacro{\muValue}{0}
\pgfmathsetmacro{\sigmaValue}{0.1}
\addplot[GREEN,thick,domain=0.6:1.4, samples=2*42, smooth]{1/(\sigmaValue*x*sqrt(2*pi))*exp(-(ln(x)-\muValue)^2/(2*\sigmaValue^2))}; \addlegendentry{$\mu=0.0,\sigma=0.1$}
\end{axis}
\end{tikzpicture}
\caption[]{\itodo{check values in literatur} Probability density function of a multiplicative \name{log normal} distribution.}
\label{fig:logNormal}
\end{figure}
% 
\paragraph{fiber segmentation}
%
To split the current straight fibers into segments for the next step, the \pymodule{fastpli.model.solver} process is used.
Each fiber is split into a mean length of $\segLength$.
%
\paragraph{fiber deformation}
After the initial seeding process, and after applying the model segment length, each \name{sphere} of a fiber will be randomly changed.
The point will be randomly displaced by a normal distribution and the radii with the log normal distribution $(\mu=0,\sigma=0.05)$.
% 
\begin{align}
\begin{split}
p &= p + \mathrm{sample}\left(\mathrm{Gaus}(\mu=0,\sigma=0.05 \cdot \fiberRadiusMean)\right)\\
r &= \fiberRadius \cdot \mathrm{sample}\left(\mathrm{LogNorm}(\mu=0,\sigma=0.05)\right)
\end{split}
\end{align}
% 
This will produce a pseudo random initial configuration for the collision solving process.
% 
\subsection{dual fiber bundle populations}
The same mathematical properties as above are true for any fiber population $F$ inside a superposition.
This means, that only a differential angle between the two orientations, so called crossing angle $\modelOmega$, is needed as well as a proportion change between both populations $\modelPsi{} = N(F_0)/N(F_G)$.
% in:
% \begin{align}
%     F_G = [\modelPsi \cdot F_0] \circ [(1-\modelPsi) \cdot F_1]
% \end{align}
% 
Since the direction of the first fiber bundle population can be again neglected, only the direction and inclination of the second fiber population relative to the first is important. Therefore it was decided to build models with \modelOmega{} from ${0,10,...,90}$ and afterwords rotating the fiber orientations around the x axis (\cref{fig:twomodelpop})
% 
% \paragraph{rest}
% % 
% As described in \cref{chap5:ShapeControl} the choice of shape parameters \segLength and \segRadius are quite important. For a realistic fiber radius distribution of around \SI{0.5}{\micro\meter} the time for a \SI{60}{\micro\meter} usable cube (\SI{105}{\micro\meter} sphere) varies from several hours up to \SI{24}{\hour}.
% 
\begin{figure}[p]
\centering
\def\tikzwidth{0.42*\textwidth}
\subcaptionbox{\label{fig:modelrotcube}A spherical volume with diameter $d$ is used as boundary, so that a cube of side length $1/1.5 \cdot d$ can be cut in any orientation inside the sphere.}
[.49\textwidth]{\inputtikz{gfx/model/sphere_cube}}\hfill
\subcaptionbox{\label{fig:modelinit}Initial orientation for two fiber populations $F_0$ and $F_1$. The angle between both populations is $\Omega$. The remaining degree of freedom are taken into account by rotating the whole volume (see \cref{fig:modelrotcube})}
[.49\textwidth]{\inputtikz{gfx/model/sphere_models}}
\\
% 
\subcaptionbox{fixed first fiber population; half rotation of second fiber population}
[.49\textwidth]{\inputtikz{gfx/model/sphere_models_a}}\hfill
\subcaptionbox{\label{subfig:Test1}increasing inclination for first fiber population}
[.49\textwidth]{\inputtikz{gfx/model/sphere_models_b}}
\\
% 
\def\tikzwidth{0.35*\textwidth}
\subcaptionbox{\label{subfig:sphere:hista1} hist a}
[.49\textwidth]{\inputtikz{gfx/model/sphere_hist_a}}\hfill
\subcaptionbox{\label{subfig:sphere:histb} hist b, with applied symmetries.}
[.49\textwidth]{\inputtikz{gfx/model/sphere_hist_b}}
\caption{two population model library \itodo{centering}}
\label{fig:twomodelpop}
\end{figure}
% 
% \begin{figure}[t!]
% \centering
% \includegraphics[width=0.5\textwidth]{dev/gfx/htm_levels.png}
% \caption{htm}
% \label{fig:htm}
% \end{figure}
%  
% 
\subsection{Algorithmic setup}\label{sec:modelSetup}
% 
To find a usable library of two fiber populations researched main attributes are listed in \cref{tab:cube2pop} \cref{tab:cube2popSoftware} contains the parameters of the additional \pymodule{fastpli.model.solver} algorithm. All \dummy{} will be repeated five times.
\itodo{AT THE END OF EACH STEP THE VOLUME TO SOLVE IS ALWAYS CUTTED TO 105.}
% 
\begin{table}[!b]
\sisetup{parse-numbers=false,open-bracket={\{}, close-bracket={\}}, list-final-separator={,},list-pair-separator={,}}%
\centering
\pgfplotstabletypeset[%
    thesisTableStyle,
    column type=lcl,
    columns/name/.style={string type},
    columns/variable/.style={string type},
    columns/values/.style={string type},
    every head row/.style={before row=\toprule,after row=\midrule},
    every last row/.style={after row=\bottomrule},
    col sep=&,
    row sep=\\,
    % string type,
]
{name & variable & values\\
mean fiber radius & $\textcolor{violet}{\fiberRadiusMean}$ & $\SIlist{0.5;1;2;5;10}{\micro\meter}$\\
mean segment length factor & $\textcolor{violet}{\segLengthFactor}$ & $\numlist{1;2;4;8}$\\
min segment bending radii factor & $\textcolor{violet}{\segRadiusFactor}$ & $\numlist{1;2;4;8}$\\
fiber bundle distribution value & $\textcolor{violet}{\modelPsi}$ & $\numlist{0.1;0.2;...;1.0}$ \\
fiber bundle crossing angle & $\textcolor{violet}{\modelOmega}$ & $\SIlist{0;10;...;90}{\degree}$\\
}
\caption{parameter\_statistic setup and \textcolor{violet}{variables}.}
\label{tab:cube2pop}
\end{table}
% 
\begin{table}[!b]
\centering
\sisetup{open-bracket={\{}, close-bracket={\}}, list-final-separator={,},list-pair-separator={,}}%
\pgfplotstabletypeset[%
    thesisTableStyle,
    column type=l,
    columns/variable/.style={string type},
    columns/value/.style={string type},
    every head row/.style={before row=\toprule,after row=\midrule},
    every last row/.style={after row=\bottomrule},
    col sep=&,
    row sep=\\,
]
{variable & value\\
pre model diameter & $d = \SI{120}{\micro\meter}$\\
mean fiber radius & $\textcolor{violet}{\fiberRadiusMean} = \SIlist{0.5;1;2;5;10}{\micro\meter}$\\
fiber radius distribution & $\fiberRadiusSig = \SI{0.1}{}$, $\fiberRadiusMu = \SI{0}{\micro\meter}$\\
seed.distance & $2 \cdot \textcolor{violet}{\fiberRadiusMean}$\\
seed.size & $2 \cdot \mathit{volume}$\\
bundle distribution & $\textcolor{violet}{\modelPsi}$\\
bundle crossing & $\textcolor{violet}{\modelOmega}$\\
solver.obj\_mean\_length & $\textcolor{violet}{\fiberRadiusMean} \cdot \textcolor{violet}{\segLengthFactor}$\\
solver.obj\_min\_radius & $\textcolor{violet}{\fiberRadiusMean} \cdot \textcolor{violet}{\segRadiusFactor}$\\
solver.max\_steps & $\SI{100000}{}$\\
max runtime & $\SI{24}{\hour}$\\
}
\caption{parameter\_statistic setup and \textcolor{violet}{variables}.}
\label{tab:cube2popSoftware}
\end{table}
\todo{show radius distribution}
% 
\subsection{Results}
% 
\paragraph{Volume fraction}
% 
\begin{figure}[p]
\centering
\includegraphics[width=\textwidth, page=1]{dev/gfx/2/parameter_statistic_box_plot_volume.pdf}
\caption[Model characteristics]{Model characteristic for $\fiberRadius = \SI{1}{\micro\meter}$ different parameters. \itodo{\segLengthFactor{} and \segRadiusFactor{}}}
\label{fig:psbp1}
\end{figure}
% 
\cref{fig:psbp1} show the resulting volume fraction $V/V_0$ for the parameter series.
Non crossing angles $||$ achive clearly a higher fraction of $V/V_0 > 0.75$ than their counter crossing parts $cross$.
Their value also is for fibers with radii $\fiberRadius <= \SI{5}{\micro\meter}$ very stable for all five repeats.
Further the volume fraction is stable for changes along the parameter $\segLengthFactor$ and $\segRadiusFactor$. 
Only the fibers with a radius of $\fiberRadius = \SI{10}{\micro\meter}$ achive smaler fractions and slighty unstable results with Values around \dummy{}.
\\
The crossing \dummy{} show a clear decrease volume fraction along a increase of the $\segLengthFactor$ as well as a slightly decrease with increasing $\segRadiusFactor$ for all fiber radii.
The decrease with the change of $\segLengthFactor$ stabilises around $\segLengthFactor = \num{8}$.
For smaller fiber radii the repeating process is more stable as for larger radii.
\\
Overall the volume fraction stays above 0.75 for parallel and fr > 2.
For crossing fibers in this range the value stays above around 0.5.
% 
\paragraph{Time development}
% 
\begin{figure}[p]
\centering
\includegraphics[width=\textwidth, page=2]{dev/gfx/2/parameter_statistic_time_evolve.pdf}
\caption[Time development parallel]{Time development of the model generation process of parallel fiber populations. non crossing\itodo{\segLengthFactor and \segRadiusFactor}\itodo{title}\itodo{units}}
\label{fig:timeDevelopmentNone}
\end{figure}
% 
\begin{figure}[p]
\centering
\includegraphics[width=\textwidth, page=1]{dev/gfx/2/parameter_statistic_time_evolve.pdf}
\caption[Time development parallel]{Time development of the model generation process of parallel fiber populations. crossing \itodo{\segLengthFactor and \segRadiusFactor}\itodo{title}\itodo{units}\itodo{restlichen parameter anhang}}
\label{fig:timeDevelopmentCross}
\end{figure}
% 
The change in time of the properties are shown in \cref{fig:timeDevelopmentNone,fig:timeDevelopmentCross}.
Looking at only the non crossing models \cref{fig:timeDevelopmentNone} shows a linear correlation between the number of steps and the time.
All models have a step size smaller than the maximal step size, therefore are completely solved and the last plotted value corresponds to the total time consumption for each parameter set.
The change of $\segLengthFactor$ has no significant influence.
An increase in $\segRadiusFactor$ on the other side clearly increases the log(time) consumption up to several order of magnitudes.
\\
% 
Looking at the number of colliding objects they correlate with the time (non log!). 
Again a change in $\segLengthFactor$ has no significant effect and an increase in $\segRadiusFactor$ increases the time consumption up to several order of magnitudes.
\\
% 
The overlap fraction coresponts to the overlapping distance/distance in total of all remaining colliding objects.
Its value at the start is non higher of \SI{8}{\percent} \dummy{}.
The values are decreasing similar to the number of colliding objects, however not as fast.
As before, a change in $\segLengthFactor$ has no significant effect and an increase in $\segRadiusFactor$ increases the time consumption up to several order of magnitudes.
% 
The comparison to crossing models in \cref{fig:timeDevelopmentCross} shows for all parameters a very similar behavior.
The development of the number of steps is exactly as for the linear case, expect that the number of steps are higher.
fl=\dummy{} and fl= \dummy{} reach the maximal number of steps, but not the maximal time value.
\todo{human time values in plot}.
The number of objects and overlapping fraction value show a splitting behavior for a change in $\segLengthFactor$.
For smaller values the time consumption is significantly (log!) smaller.
larger values show a stagnant behavior for the parameters, however already for small values (log!).
A change in $\segRadiusFactor$  increases the time consumption up to several order of magnitudes as in the linear bundle case.
% 
% 
% 
\subsection{Discussion}
% 
The goal is to choice a set of parameters, which allow a) fast, b) collision free and c) a high volume fraction for densely fibers.
In the case of parallel fibers, the solving process is always faster than for crossing bundles.
Even thow that the number of colliding objects is more or less \dummy{} the same \comment{(ein plot?)} the needed volume to have enough space to not collide with each other is larger \dummy{}.
Therefore the distance the fiber segments have to travel is higher und the number of steps to achive this increases as well.
\\
% 
The behavior in change of the length factor \segLengthFactor{} is clearly a time advantage, since also the number ob objects is smaller.
However a larger \segLengthFactor{} results for crossing fibers as to be expected in a smaller volume fraction.
For parallel fiber is is reasonable that the volume fraction das not change, since the direction of movement for all fiber segments is radial symmetric along their main orientation axis.
Up to a fiber radii of \SI{2}{\micro\meter} the repeating measurements are stable.
Above it the resulting orientations starts to divers.
This has to to with that the volume has a fixed size of \SI{60}{\micro\meter}.
This means the number of segments is quite small, individual and the model is therefore diverge.
\\
The fiber semgent bending radii factor \segRadiusFactor{} yield to less diverse results.
Since it restrict the bending radii, it is expected, and visible in the results, that the volume fraction is very influenced, since the volume can't be optimal filled anymore.
Again changes parallel fiber orientation are almost not visible, for all analysed values.
Crossing fibers however are as expected influenced.
This is especial visible in the number of colliding objects, where the \segRadiusFactor{} splits the data into individual branches over time.
Since smaller values of \segRadiusFactor{} allow more curved geometries, this is as expected.
However this can lead to \say{strange looking} results and has to be set with an anatomical perspective. \todo{images}
\\[\baselineskip]
% 
Overall the choice of the parameters can be narrowed.
The main decision come from the crossing results.
Since most basic parameter is the length length factor \segLengthFactor{}.
Looking at the volume fraction results it should be as small as possible.
However since the difference between $\segLengthFactor=\SI{1}{}$ and $\segLengthFactor=\SI{2}{}$ is small, and a big leap is visible for $\segLengthFactor=\SI{4}{}$ one can use $\segLengthFactor=\SI{2}{}$.
The only reason to increase this value further would be a reduction in computational time.
\\
% 
The fiber radii should be as realistic to real \acs{WM} brain tissue as possible.
However to reduce the computational time further, a reduction to $r = \SI{1}{\micro\meter}$ is feasible.
It is still in the same order of magnitude to the real values (\SI{0.5}{\micro\meter}).
The \ac{3D-PLI} simulation results will show more effective metric to further restrict these parameters.
% 
The choice of the fiber banding factor is as already mentioned, more a anatomical restriction.
However it can be resend, that it has no benefit to reduce its value more then 1 or fibers can (with a small fiber segment length) move perfectly around another fiber, like horseshoe shaped.
To work against this, but not to further restrict the model geometry a value of 2 is chosen.
Therefore $\segLengthFactor = \SI{2}{}, \segLengthFactor=\SI{2}{}$ and $\fiberRadius=\SI{1}{\micro\meter}$.
\\
% 
A last remark.
An additional property to reduce the computational time is to not completely solve the model. 
Looking at the overlap fraction of the remaining overlapping segments, a value of $<\SI{1}{\percent}$ can be feasible.
This this an additional order of magnitude can be potential saved.
However, the effect inside the simulation has to be studied.
% 
\section{CPU Acceleration}
% 
\begin{figure}[!t]
\centering
\includegraphics[]{dev/gfx/4/model_solver_cubes.pdf}
\caption[speedup]{\itodo{cores, not threads} \itodo{farben?}}
\label{fig:solverSpeedup}
\end{figure}
% 
\itodo{Welche Parameter ...}
% 
As described in \dummy{} \openmp{} is used for acceleration.
This means no usage of multiple computer nodes is currently available.
\cref{fig:solverSpeedup} shows a speedup up to eight cores.
A number of two cores gives a good speedup of around $1.8$, three cores around $2.5$ and four cores around $3$.
A further incresse of core numbers does not benefit the computational time much.
This has most likely to do with the fact, that the data has to transvered between all the cores and this takes quite some time.
Even if the algorithm is especially optimized to reduce the amount of data to be copied, the paralysed instructions are often very short (\eg{} move positions), with the exception of the distance calculation.
Since all data is linear in memory, the cpu can use the full potential of the prefetcher and calculate very fast.
\\[\baselineskip]
% 
The results show, that especially to increase the volume size, other algorithms are needed. 
Here the \ac{GPU} seems to be the hardware of choice.
% 
\section{Building models for simulation}
% 
With the upper chosen model parameters the final models can be build.
To be able to study the effect of the fiber radii on the simulation, all radii are generated.
In this section the resulting orientation inside the volume, \ie{} the orientation of the fiber segments, will be analysed.
The same setup as above (see \cref{sec:modelSetup}) is chosen with fix $\segLengthFactor=\SI{2}{}$ and $\segRadiusFactor = \SI{2}{}$.
Using the rotational model from above, only fibers with a $\Psi =  0...90$ and $\Omega = 0.1...1.0$ are generated.
% 
\subsection{Results}
% 
\begin{figure}[!t]
\centering
% \resizebox{1.0\textwidth}{!}{
\includegraphics[width=\textwidth, page=1]{dev/gfx/2/cube_2pop_orientation_hist2d.pdf}
% }
\caption[Model orientation histograms]{distribution of fiber segment orientation in initial and resulting models for $\fiberRadius = \SI{1}{\micro\meter}$. \itodo{fit ESAG}}
\label{fig:modelOrientation}
\end{figure}
% 
\begin{figure}[p]
\centering
% \resizebox{1.0\textwidth}{!}{
\includegraphics[width=\textwidth, page=1]{dev/gfx/2/cube_2pop_orientation_hist.pdf}
% }
\caption[Model orientation histograms]{Maximum normed distribution of fiber segment orientation in initial and resulting models. The left half circle contains the inclination $\alpha$ value, the right half the direction $\varphi$. \itodo{which norm?}}
\label{fig:modelOrientationHist1d}
\end{figure}
% 
The results are visualized in two polar axis plots in \cref{fig:modelOrientationHist1d}. On the right hemisphere the direction histogram is shown.
The left hemisphere shows the inclination distribution.
Both plots are decoupled from each other. \todo{histograms mit line plots?}
Each value is normed to the maximum of that curve so that the shape is visible.
A 3d visualized model is printed in the corner of each parameterset.
% 
The subset of results show that for all radii the fibers rich the same resulting distribution of orientations. 
These distributions are broder than the inital values and are centered around their initial orientations.
The resulting 3d visualized models show all an interwoven structure, where both fiber population orientations are clearly visible. \todo{anhang}
%  
\subsection{Discussion}
% 
\vspace{5pt}
\hrule
\vspace{6pt}
% 
