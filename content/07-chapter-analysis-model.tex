\setcounter{chapter}{6}
\chapter{Dense \acs{WM} modelling}
\label{cha:model_analysis}
% 
\section{Introduction}
% 
In the previous chapter \cref{chap:sof:modelling} the module \pymodule{fastpli.model} was described to build non colliding nerve fiber models \cite{Matuschke2019, Matuschke2021}.
The question is however, how to build them, and with what sets of parameters.
Since the collision solving algorithm splits the nerve fibers into fiber segments and also controls there movement and bending while solving the colliding parts, its parameters have a influence on the resulting nerve fiber configuration.
How big this influence is the main research of this chapter.
A satisfying goal would be to find a set of parameters, which results in usable nerve fiber models where the input configuration mainly specifies the output configuration.
% 
\par
Three goals are \dummy{}.
The first is to be able to create a very dens volume.
This of course depends on the initial fiber configuration.
Configurations like crossings \eg{} will reduce the density.
The second goal is to minimize the computational time.
This will result in a more usable systems since the user can generate more models for the simulation part.
The last goal is, that the initial fiber orientations remain intact.
Due to the movement phase in the collision solver algorithm it is the case, that the orientations will change.
The question is how much are they changing and is this appropriate to a users concepts and anatomical reality.
\par
Anatomically nerve fibers have a radius of around \SI{0.5}{\micro\meter} to several \si{\micro\meter} in the \ac{WM} (see \cref{chap:neuro}).
This means that inside a \SI{60}{\micro\meter} thick tissue section up to 60 layers of nerve fibers have space.
For the simulation a \ac{VOI} of $\SI{65}{\micro\meter} \times \SI{65}{\micro\meter} \times \SI{60}{\micro\meter}$ was chosen due to limitations in the tissue generation ans simulation step, which will be discussed this and the next chapter in detail.
The main consideration for both parts is the limitation of memory size and computation time for the needed number of models and simulations.
\\
% 
Inside this \ac{VOI} theoretically a very large number of configurations exists, since every single nerve fiber is defined by multiple points in space.
However anatomically only a subset of configurations is reasonable.
Still the number of possibilities is quite huge.
\\
% 
Therefore the first part of this chapter defines a parameter sets which limits the possibility of configurations, without (or almost not) restricting the mathematically solution space.
Once found such a parameter description the behavior of the parameters from the collision solving algorithm will be investigated.
From this study a set of working parameters for the next simulation chapter will be chosen which again will not (or mostly not) restrict the outcome of the simulations.

Finally the algorithms parallelization will be investigated.
% 
% After describing the functionality of the \pymodule{fastpli.model}, the next task is to use these methods not only to create realistic dense \ac{WM} models, but to keep them as simple as possible due to the complexity of the tissue.
% This is due to the fact that \ac{WM} contains individual nerve fibers that typically have a size in the order of about $\SI{1}{\micro\meter}$.
% Therefore, in a \SI{60}{\micro\meter} voxel of a \ac{LAP} measured \ac{3D-PLI} can be image within the \ac{WM} several thousand individual nerve fibers are already present.
% Considering that each nerve fiber has a unique trajectory through this volume, this means that theoretically an absurd variety of possible configurations exists.
% However, due to the nature of the \ac{3D-PLI} structure, previous studies have shown that the result of the signal depends on much less degrees of freedom than each individual nerve fiber has.
% \par
% % 
% Therefore, this work, being the first study of its kind, focuses mainly on two randomly interwoven fiber populations for \ac{3D-PLI} simulations.
% Another focus is the generation of such models, whereby the computational time effort shall be kept as low as possible.
% The analysis refers to the setting of the parameters for the model generation and their influence on the resulting collision-free configurations.
% 
% 
\section{Designing fiber populations}
% 
\subsection{Orientation and proportions}
% 
In this theses up to two fiber populations are investigated. \todo{argue why}
To limit the number of necessary models, one can .. the following symmetry arguments.
% 
% \begin{figure}[p]
% \centering
% \def\tikzwidth{0.42*\textwidth}
% \subcaptionbox{\label{fig:modelrotcube}A spherical volume with diameter $d$ is used as boundary, so that a cube of side length $1/1.5 \cdot d$ can be cut in any orientation inside the sphere.}
% [.49\textwidth]{\inputtikz{gfx/model/sphere_cube}}\hfill
% \subcaptionbox{\label{fig:modelinit}Initial orientation for two fiber populations $F_0$ and $F_1$. The angle between both populations is $\Omega$. The remaining degree of freedom are taken into account by rotating the whole volume (see \cref{fig:modelrotcube})}
% [.49\textwidth]{\inputtikz{gfx/model/sphere_models}}
% \\
% % 
% \subcaptionbox{fixed first fiber population; half rotation of second fiber population}
% [.49\textwidth]{\inputtikz{gfx/model/sphere_models_a}}\hfill
% \subcaptionbox{\label{subfig:Test1}increasing inclination for first fiber population}
% [.49\textwidth]{\inputtikz{gfx/model/sphere_models_b}}
% \\
% % 
% \def\tikzwidth{0.35*\textwidth}
% \subcaptionbox{\label{subfig:sphere:hista1} hist a}
% [.49\textwidth]{\inputtikz{gfx/model/sphere_hist_a}}\hfill
% \subcaptionbox{\label{subfig:sphere:histb} hist b, with applied symmetries.}
% [.49\textwidth]{\inputtikz{gfx/model/sphere_hist_b}}
% \caption{two population model library \itodo{centering} \itodo{e und f fertig machen}}
% \label{fig:twomodelpop}
% \end{figure}
% 
For investigating a single fiber population, only one model is needed, since the model can be rotated afterwards into any 3d orientation.
Of course one has to check if a second random model with the same configurations will yield into a significant different model and simulation signal, which will be later investigate.
For two fiber populations only the crossing angle $\Omega$ between both fiber population orientations is relevant (see \cref{fig:modelinit}).
Because of the fact that only the orientation and not the vector is relevant, the crossing angle has only to increase up to \SI{90}{\degree}.
Again with rotations one can rotate both fiber populations in any orientation with preserving the crossing angle.
Therefore only models for a set of crossing angles $\Omega$ have to be generated.
An additional parameter is the proportion between both populations $\Psi=N_0/N_G$.
If one keeps every other parameter the same as it is done for this study \todo{argue why}, \eg{} the radial distributions inside a population, no other parameter is needed to characterize a two fiber population model.
\par
% 
Therefore the following sets of parameters were chosen which allows to investigate up to two fiber populations:
\begin{align}
    \begin{split}
        \Omega = \{\SI{0}{\degree}, \SI{10}{\degree}, ..., \SI{90}{\degree}\}\\
        \Psi = \{\SI{0.1}{}, \SI{0.2}{}, ..., \SI{0.9}{}\}
    \end{split}
\end{align}
In the case of $\Psi = 0$ or $\Psi = 1$ no second fiber population exists, therefore the single fiber population model can be applied.
This leads to 91 needed models for the chosen orientations.
% 
\subsection{fiber positions distribution and deformation}
% 
To design the individual fiber configurations for each fiber population the methods described in \cref{sec:sandbox} are used.
Seedpoints on a 2d plane are generated with a uniform distribution:
\begin{align}
p = \mathrm{Uniform}(-\frac{1}{2}\mathit{size},\frac{1}{2}\mathit{size})
\end{align}
The $\mathit{size}$ will be choosen so that the model can be fully filled.
Since the simulating model will be cubic, and the model shell be rotateble, a spherical boundry of diameter $d_{\mathit{sphere}}=\sqrt(3) \mathit{size}$ is choosen.
The number of seed points is set to a value of 
\begin{align}
N_{0,\mathit{seeds}} &= \Psi \frac{\mathit{size}^2}{\pi \cdot \r_{\mathit{fiber}}}\\
N_{1,\mathit{seeds}} &= (1-\Psi) \frac{\mathit{size}^2}{\pi \cdot \r_{\mathit{fiber}}}
\end{align}
which corresponds of filling the entire cross section area with the sum of all cross sections of fibers with respect to the fiber populations proportion.
This way more fibers will be seeded in the volume than they have space, since the stacking of circles is mathematically limited to a volume fraction of $\frac{\pi \sqrt{3}}{6} \approx 0.9$.
This will lead statistically to overlapping regions and fibers to be pushed outside the \ac{VOI}.
This is also necessary because the fibers at the boarder of the \ac{VOI} will need also fibers surrounding them to apply some kind of pressure.
Therefore the size of the generated volume will be increased by 2 fiber diameters so that no boundary effects can occur.
\par
% 
\begin{figure}[!t]
\centering
\tikzset{external/export=false}
\begin{tikzpicture}[scale=1, trim axis left, trim axis right]
\begin{axis}[height=0.46\textwidth, width=0.75\textwidth,enlargelimits=false, xlabel={$x$}, ylabel={$f(x,\mu,\sigma)$}, title=${f(x,\mu,\sigma)=\frac{1}{\sigma x \sqrt{2\pi}}\exp\left(-\frac{(\ln(x)-\mu)^2}{2 \sigma^2}\right)}$,
legend style={at={(1,1)},anchor=north east},
legend cell align={left},
]
\pgfmathsetmacro{\muValue}{0}
\pgfmathsetmacro{\sigmaValue}{0.05}
\addplot[BLUE,thick,domain=0.6:1.4, samples=2*42, smooth]{1/(\sigmaValue*x*sqrt(2*pi))*exp(-(ln(x)-\muValue)^2/(2*\sigmaValue^2))}; \addlegendentry{$\mu=0.0,\sigma=0.05$}
\pgfmathsetmacro{\muValue}{0}
\pgfmathsetmacro{\sigmaValue}{0.1}
\addplot[GREEN,thick,domain=0.6:1.4, samples=2*42, smooth]{1/(\sigmaValue*x*sqrt(2*pi))*exp(-(ln(x)-\muValue)^2/(2*\sigmaValue^2))}; \addlegendentry{$\mu=0.0,\sigma=0.1$}
\end{axis}
\end{tikzpicture}
\caption[]{\itodo{check values in literatur} Probability density function of a multiplicative \name{log normal} distribution.}
\label{fig:logNormal}
\end{figure}
% 
With these seedpoints straight parallel fibers are placed inside a cubic volume.
To add a random distribution of fiber radii, the targeting mean fiber radius $\fiberRadiusMean$ is multiplied by a random value of the LogNormal distribution (see \cref{fig:logNormal}) to ensure that the mean value is preserved:
\begin{align}
\fiberRadius = \fiberRadiusMean \cdot \mathrm{sample}\left(\mathrm{LogNormal}(\mu=0,\sigma=0.1)\right)
\end{align}
% 
To generate a more random distribution along the fibers the fibers have to be split first into fiber segments.
Here the \code{Solver} class with its method \code{Solver.apply\_boundaries()}.
It will apply the set fiber segment length to the fiber configuration which in this case will split the fiber along there trajectory in equally long fiber segments (except the last one).
The in this way generated fiber points will next be randomly shifted in all three dimensions by a normal distribution.
Additionally the radius of the point will also be changed with a randomly multiplicative factor from a LogNormal distribution.
% 
\begin{align}
\begin{split}
p_i &= p_i + \mathrm{Normal}(\mu=0,\sigma=0.05 \cdot \fiberRadiusMean)\\
r_i &= r_i \cdot \mathrm{LogNormal}(\mu=0,\sigma=0.05)
\end{split}
\end{align}
% 
The values are chosen according to \todo{...}.
\par
%  
All described methods are aplied to each fiber population.
This results in the initial fiber configurations, which will in the next step solved for collisions.
% 
% 
% 
\subsection{Parameter characterization}\label{sec:modelSetup}
% 
The described control mechanism in the collision solver algorithm \code{fastpli.model.solver} (see \cref{chap:sof:modelling}) have to be characterized.
These are the \segLength{} and the \segRadius{}.
One has to make sure, that a set of parameters is found, which will ensure that the users input configurations stays the same, meaning the orientation distributions remain intact with respect that the fiber segments have to move.
Another important factor is that the resulting fiber model achieves a high density.
Additionally the parameters will have a significant impact on the computational time.
Here it is feasible to search for parameter configurations, which will reduce the computation time, since it is an limited resource.
% 
To investigate the above mentioned \dummy{} the following parameters in \cref{tab:cube2pop} will be investigated for different fiber radii \fiberRadiusMean{}.
\segLengthFactor{} and \segRadiusFactor{} describe the \segLength{} and \segRadius{} as a factor of the \fiberRadiusMean:
\begin{align}
    \begin{split}
        \segLength &= \segLengthFactor \cdot \fiberRadiusMean\\
        \segRadius &= \segRadiusFactor \cdot \fiberRadiusMean
    \end{split}
\end{align}
% 
\begin{table}[!b]
\sisetup{parse-numbers=false,open-bracket={\{}, close-bracket={\}}, list-final-separator={,},list-pair-separator={,}}%
\centering
\pgfplotstabletypeset[%
    thesisTableStyle,
    column type=lcl,
    columns/name/.style={string type},
    columns/variable/.style={string type},
    columns/values/.style={string type},
    every head row/.style={before row=\toprule,after row=\midrule},
    every last row/.style={after row=\bottomrule},
    col sep=&,
    row sep=\\,
    % string type,
]
{name & variable & values\\
mean fiber radius & $\textcolor{violet}{\fiberRadiusMean}$ & $\SIlist{0.5;1;2;5;10}{\micro\meter}$\\
mean segment length factor & $\textcolor{violet}{\segLengthFactor}$ & $\numlist{1;2;4;8}$\\
min segment bending radii factor & $\textcolor{violet}{\segRadiusFactor}$ & $\numlist{1;2;4;8}$\\
% fiber bundle distribution value & $\textcolor{violet}{\modelPsi}$ & $\numlist{0.1;0.2;...;1.0}$ \\
% fiber bundle crossing angle & $\textcolor{violet}{\modelOmega}$ & $\SIlist{0;10;...;90}{\degree}$\\
fiber bundle crossing/proportion & $\textcolor{violet}{\modelPsi}$/$\textcolor{violet}{\modelOmega}$ & $1.0/\SI{0}{\degree}$, $0.5/\SI{90}{\degree}$\\
}
\caption{parameter characterization setup and \textcolor{violet}{variables}.}
\label{tab:cube2pop}
\end{table}
% 
% \begin{table}[!b]
% \centering
% \sisetup{open-bracket={\{}, close-bracket={\}}, list-final-separator={,},list-pair-separator={,}}%
% \pgfplotstabletypeset[%
%     thesisTableStyle,
%     column type=l,
%     columns/variable/.style={string type},
%     columns/value/.style={string type},
%     every head row/.style={before row=\toprule,after row=\midrule},
%     every last row/.style={after row=\bottomrule},
%     col sep=&,
%     row sep=\\,
% ]
% {variable & value\\
% $n_{\mathit{repeat}}$ & $\SI{48}{}$ \\
% voi & $\SI{60}{\micro\meter} \times \SI{60}{\micro\meter} \times \SI{60}{\micro\meter}$\\
% mean fiber radius & $\textcolor{violet}{\fiberRadiusMean} = \SIlist{0.5;1;2;5;10}{\micro\meter}$\\
% fiber radius distribution & $\fiberRadiusSig = \SI{0.1}{}$, $\fiberRadiusMu = \SI{0}{}$\\
% solver.obj\_mean\_length & $\textcolor{violet}{\fiberRadiusMean} \cdot \textcolor{violet}{\segLengthFactor}$\\
% solver.obj\_min\_radius & $\textcolor{violet}{\fiberRadiusMean} \cdot \textcolor{violet}{\segRadiusFactor}$\\
% solver.max\_steps & $\SI{100000}{}$\\
% }
% \caption{parameter\_statistic setup and \textcolor{violet}{variables}.}
% \label{tab:cube2popSoftware}
% \end{table}
% 
To be able to statistically investigate the results $n_{\mathit{repeat}} = \SI{24}{}$ repeating generations were computed. \footnote{The used CPU has 48 cores}.
For the characterization only the pair $\modelPsi/\modelOmega$ of $1.0/\SI{0}{\degree} (||)$ and $0.5/\SI{90}{\degree} (\times)$ are considered as extreme cases.
The number of steps is set to \SI{100000}{} to limit the computation.
% 
At every 50 steps the fiber model is cut into a $\SI{60}{\micro\meter}+4*\fiberRadiusMean$ cube to delete unnecessary fibers and reduce the amount of objects.
Befor the orientation is analysed from the results the volume is cut to $\SI{60}{\micro\meter}$ and therefore only the in the simulation remaining fiber segments will remain.
% 
% The parameters are set to the values in \cref{tab:cube2popSoftware}.
% 
\todo{volume fration is measured by generating the discretised volume and counting the occupied voxels, 60 cube, vs 0.1}
% 
\todo{time evole fr 1 und 2 nicht unterscheidbar}
\todo{Intel(R) Xeon(R) CPU E5-4657L v2 @ 2.40GHz, L1d cache:1.5 MiB,L1i cache:1.5 MiB,L2 cache:12 MiB,L3 cache:120 MiB}
% 
% 
% 
\subsection{Results}
% 
\paragraph{Volume fraction}
% 
\begin{figure}[p]
\centering
\includegraphics[width=\textwidth, page=1]{dev/gfx/2/parameter_statistic_box_plot_volume.pdf}
\caption[Model characteristics]{Model characteristic for $\fiberRadius = \SI{1}{\micro\meter}$ different parameters.}
\label{fig:psbp1}
\end{figure}
% 
\cref{fig:psbp1} show the resulting volume fraction $V/V_0$ for the parameter series.
For a single fiber population $(||)$ the volume fraction $V/V_0$ is almost constant at about $\SI{0.75}{}$.
The value slightly decreases with increasig mean fiber radius \fiberRadiusMean{}.
The \segLengthFactor{} nor the \segRadiusFactor{} have an essential effect.
Only a slight decrease of the volume fraction is visible for increasing \segLengthFactor{}.
The first significant change is visible for the largest mean fiber radius $\fiberRadiusMean=\SI{10}{\micro\meter}$.
The variance of the volume fraction increases slightly with increasing mean fiber radius \fiberRadiusMean{}.
For mean fiber radii $\fiberRadiusMean >= \SI{5}{\micro\meter}$ the variance increases significantly.
\par
% 
The crossing fiber populations $(\times)$ the highest values are achieved for $\segRadiusFactor=\SI{1}{}$ of about \numrange{0.6}{0.72}{} depending on \fiberRadiusMean{}, however there are still lower than the single fiber population.
The volume fraction decreases significantly with increasing \segRadiusFactor{}.
Only for \segLengthFactor{} = 8 the volume fractions does not change anymore with the \segRadiusFactor{}.
The \segLengthFactor{} decreases the volume fraction as well over all mean fiber radii \fiberRadiusMean{}.
% 
\paragraph{Computation time}
% 
\begin{figure}[p]
\centering
\includegraphics[width=\textwidth, page=2]{dev/gfx/2/parameter_statistic_time_evolve.pdf}
\caption[Time development parallel]{Time development of the model generation process of parallel fiber populations. non crossing\itodo{title}\itodo{restlichen parameter anhang}}
\label{fig:timeDevelopmentNone}
\end{figure}
% 
\begin{figure}[p]
\centering
\includegraphics[width=\textwidth, page=1]{dev/gfx/2/parameter_statistic_time_evolve.pdf}
\caption[Time development parallel]{Time development of the model generation process of parallel fiber populations. crossing \itodo{\segLengthFactor and \segRadiusFactor}\itodo{title}\itodo{restlichen parameter anhang}}
\label{fig:timeDevelopmentCross}
\end{figure}
% 
The change in computation time of the parameter series are shown in \cref{fig:timeDevelopmentNone} for the single fiber population and in \cref{fig:timeDevelopmentCross} for the crossing fiber population for number of steps, number of colliding fiber segments and the overlap fraction of the colliding fiber segments.
\par
% 
The single fiber populations show a linear correlation between the computation time and the number of steps for all parameters.
The number of steps increase significantly with decreasing \segLengthFactor{} as well as decreasing \fiberRadiusMean{}.
The increase in computational time is significantly higher, about one magnitude, with decreasing \fiberRadiusMean{} with respect tot the \segLengthFactor{}.
A change of the computational time with changing the fiber bending radius \segRadiusFactor{} is not visible.
The total number of steps also increase with increasing mean fiber radius \fiberRadiusMean{} and decrease slightly with increased \segLengthFactor{}.
All models of all parameter sets were  able to solve the collisions in the maximum number of steps.
\\
The number of colliding fiber segments in the second plot show a exponential decrease for increasing computational time for all parameters.
The total number increases with decreasing \segLengthFactor{} as well as decreasing \fiberRadiusMean{}.
Again the influence of the \fiberRadiusMean{} is more significant.
The \segRadiusFactor{} has here no significant effect as well.
\\
% 
The remaining overlap fraction show a behavior with increasing computational time.
For all parameters the beginning value is about $\SI{4}{\percent}$ and decreases over time to about $\SI{1}{\percent}$ before the model is solved and the value is therefore $\SI{0}{\percent}$.
The decreasing effect is almost linear.
For increasing mean fiber radii \fiberRadiusMean{} the linearity bends slightly and the decreasing increases for about the last half of the total computation time. 
At the end of every parameter set the variance of the remaining overlap fraction increases significantly.
\par
% 
The crossing fiber population shows a linear behavior for the number of steps as well for all parameter sets.
As for the single fiber population case, a decreasing \fiberRadiusMean{} increases the computational time significantly more than a decrease in \segLength{}.
The increase of the computational time by decreasing the mean fiber radius is as for the single fiber population case again about one magnitude.
A key difference to the single fiber population is the reduction of computational time with an increase of the minimal allowed fiber bending radius factor \segRadiusFactor{}.
In the case of \dummy{} and \dummy{} the maximum number of steps were reached.
\\
The number of colliding fiber segments show also a exponential decrease as in the case of a single fiber population.
The key difference is that with an increase of the minimal fiber bending radius factor \segRadiusFactor{} this behavier changes drastically.
The exponential decrease seams to split at a critial number of steps (or computational time) and only decreases linear from there on for higher \segRadiusFactor{}.
This splitting however only occurse for the smaller \segLengthFactor{}.
The slop of the second phase is decreased for higher \segRadiusFactor{}.
This behavier is more and more evident with decreasing \fiberRadiusMean{} and \segLengthFactor{}.
The spliting point with regards to the computational time very close to the total computational time of the lowest \segRadiusFactor{}.
\\
The remaining overlap fraction shows for the smaller fiber segment length factor  \segLengthFactor{} a differents with respect to the single fiber population case.
For the smaller \segLengthFactor{} the curve almost follows a logistic curve.
Where for the higher \segLengthFactor{} the curve stops at the turning point, for the smaller values it continues and the number of remaining overlap fraction less and less decreases until it almost stays constant until the model is solved or the total number of steps is reached.
Again the mean fiber radius \fiberRadiusMean{} does not change the curve significantly.
The lower values for the remaining overlap fraction is as well about $\SI{1}{\percent}$ at the end of the solving steps.
% 
% 
% 
\subsection{Discussion}
% 

% 
\itodo{zusammenfassung der gewaehlten parameter}
\itodo{trennung zu overall discussion}
\itodo{repo messung mit in die buolding simulation model}
% 
\par
\noindent\rule{\textwidth}{2pt}
\par
% 
The goal is to choice a set of parameters, which allow a) fast, b) collision free and c) a high volume fraction for densely fibers.
In the case of parallel fibers, the solving process is always faster than for crossing bundles.
Even thow that the number of colliding objects is more or less \dummy{} the same \dummy{(ein plot?)} the needed volume to have enough space to not collide with each other is larger \dummy{}.
Therefore the distance the fiber segments have to travel is higher und the number of steps to achive this increases as well.
\\
% 
The behavior in change of the length factor \segLengthFactor{} is clearly a time advantage, since also the number ob objects is smaller.
However a larger \segLengthFactor{} results for crossing fibers as to be expected in a smaller volume fraction.
For parallel fiber is is reasonable that the volume fraction das not change, since the direction of movement for all fiber segments is radial symmetric along their main orientation axis.
Up to a fiber radii of \SI{2}{\micro\meter} the repeating measurements are stable.
Above it the resulting orientations starts to divers.
This has to to with that the volume has a fixed size of \SI{60}{\micro\meter}.
This means the number of segments is quite small, individual and the model is therefore diverge.
\\
The fiber semgent bending radii factor \segRadiusFactor{} yield to less diverse results.
Since it restrict the bending radii, it is expected, and visible in the results, that the volume fraction is very influenced, since the volume can't be optimal filled anymore.
Again changes parallel fiber orientation are almost not visible, for all analysed values.
Crossing fibers however are as expected influenced.
This is especial visible in the number of colliding objects, where the \segRadiusFactor{} splits the data into individual branches over time.
Since smaller values of \segRadiusFactor{} allow more curved geometries, this is as expected.
However this can lead to \say{strange looking} results and has to be set with an anatomical perspective. \todo{images}
\par
% 
Overall the choice of the parameters can be narrowed.
The main decision come from the crossing results.
Since most basic parameter is the length length factor \segLengthFactor{}.
Looking at the volume fraction results it should be as small as possible.
However since the difference between $\segLengthFactor=\SI{1}{}$ and $\segLengthFactor=\SI{2}{}$ is small, and a big leap is visible for $\segLengthFactor=\SI{4}{}$ one can use $\segLengthFactor=\SI{2}{}$.
The only reason to increase this value further would be a reduction in computational time.
\\
% 
The fiber radii should be as realistic to real \acs{WM} brain tissue as possible.
However to reduce the computational time further, a reduction to $r = \SI{1}{\micro\meter}$ is feasible.
It is still in the same order of magnitude to the real values (\SI{0.5}{\micro\meter}).
The \ac{3D-PLI} simulation results will show more effective metric to further restrict these parameters.
% 
The choice of the fiber banding factor is as already mentioned, more a anatomical restriction.
However it can be resend, that it has no benefit to reduce its value more then 1 or fibers can (with a small fiber segment length) move perfectly around another fiber, like horseshoe shaped.
To work against this, but not to further restrict the model geometry a value of 2 is chosen.
Therefore $\segLengthFactor = \SI{2}{}, \segLengthFactor=\SI{2}{}$ and $\fiberRadius=\SI{1}{\micro\meter}$.
\\
% 
A last remark.
An additional property to reduce the computational time is to not completely solve the model. 
Looking at the overlap fraction of the remaining overlapping segments, a value of $<\SI{1}{\percent}$ can be feasible.
This this an additional order of magnitude can be potential saved.
However, the effect inside the simulation has to be studied.
% 
\section{CPU Acceleration}
% 
\begin{figure}[!t]
\centering
\includegraphics[]{dev/gfx/4/model_solver_cubes.pdf}
\caption[speedup]{\itodo{cores, not threads} \itodo{farben?}}
\label{fig:solverSpeedup}
\end{figure}
% 
\itodo{Welche Parameter ...}
% 
As described in \dummy{} \openmp{} is used for acceleration.
This means no usage of multiple computer nodes is currently available.
\cref{fig:solverSpeedup} shows a speedup up to eight cores.
A number of two cores gives a good speedup of around $1.8$, three cores around $2.5$ and four cores around $3$.
A further incresse of core numbers does not benefit the computational time much.
This has most likely to do with the fact, that the data has to transvered between all the cores and this takes quite some time.
Even if the algorithm is especially optimized to reduce the amount of data to be copied, the paralysed instructions are often very short (\eg{} move positions), with the exception of the distance calculation.
Since all data is linear in memory, the cpu can use the full potential of the prefetcher and calculate very fast.
\par
% 
The results show, that especially to increase the volume size, other algorithms are needed. 
Here the \ac{GPU} seems to be the hardware of choice.
% 
% 
% 
\section{Repo Messungen}
% 
\begin{table}
\resizebox{\textwidth}{!}{
\pgfplotstabletypeset[%
    thesisTableStyle,
    columns={omega,psi,radius,state, pop,mean_mean,mean_std,std_mean,std_std,25_mean,25_std,50_mean,50_std,75_mean,75_std},
    % sort, sort key=omega,
    every head row/.style={after row={\si{\degree} & & \si{\micro\meter} & & & & &\si{\degree} & &\si{\degree} & &\si{\degree} & &\si{\degree} & &\si{\degree} & &\si{\degree} & &\si{\degree} & &\si{\degree} & &\si{\degree} & \\ \midrule}},
    columns/state/.style={string type},
    columns/mean_mean/.style={column name=$\mean(<d\Omega>_0)$,sci,sci zerofill,sci subscript,precision=2,dec sep align},
    columns/std_mean/.style={column name=$\mean(\sigma(d\Omega)_0)$,sci,sci zerofill,sci subscript,precision=2,dec sep align},
    columns/25_mean/.style={column name=$\mean(25(d\Omega)_0)$,sci,sci zerofill,sci subscript,precision=2,dec sep align},
    columns/50_mean/.style={column name=$\mean(50(d\Omega)_0)$,sci,sci zerofill,sci subscript,precision=2,dec sep align},
    columns/75_mean/.style={column name=$\mean(75(d\Omega)_0)$,sci,sci zerofill,sci subscript,precision=2,dec sep align},
    columns/mean_std/.style={column name=$\std(<d\Omega>_0)$,sci,sci zerofill,sci subscript,precision=2,dec sep align},
    columns/std_std/.style={column name=$\std(\sigma(d\Omega)_0)$,sci, sci zerofill,sci subscript,precision=2,dec sep align},
    columns/25_std/.style={column name=$\std(25(d\Omega)_0)$,sci,sci zerofill,sci subscript,precision=2,dec sep align},
    columns/50_std/.style={column name=$\std(50(d\Omega)_0)$,sci,sci zerofill,sci subscript,precision=2,dec sep align},
    columns/75_std/.style={column name=$\std(75(d\Omega)_0)$,sci,sci zerofill,sci subscript,precision=2,dec sep align},
    % column type=ccccccccccccccc,
    col sep=comma,
]
{dev/rc1/repo/omegas_ms.csv}
}
\caption[repo angle results]{mean and std of opening angle $d\Omega$ in degree. The lower case number indicates the 10er exponent}
\end{table}
% 
\par
From the statistic above one notice that the initial fiber statistic is the same for all configurations from 1.4+-0.0 to 3.0+-0.1 [25-75].
The mean orientation for both fiber population show withing $10^-5$ in the direction of the x and y axis.
For parallel fibers the angle omega goes from 3.0+-0.1 to 8.0+-0.3 [25-75]. For crossing fibers from 9.5+-0.2 to 26.2+-0.5 [25-75].
\par
% 
This results indicate because of the small standard deviation of the angle omega the ..., that not many models are needed, since the statistical orientations of the fiber segments inside the models are stable with less than 1 degree.
However it still has to be shown, that it has no significant impact on the simulation side.
% 
% 
% 
\section{Building models for simulation}
% 
With the upper chosen model parameters the final models can be build.
To be able to study the effect of the fiber radii on the simulation, all radii are generated.
In this section the resulting orientation inside the volume, \ie{} the orientation of the fiber segments, will be analysed.
The same setup as above (see \cref{sec:modelSetup}) is chosen with fix $\segLengthFactor=\SI{2}{}$ and $\segRadiusFactor = \SI{2}{}$.
Using the rotational model from above, only fibers with a $\Psi =  0...90$ and $\Omega = 0.1...1.0$ are generated.
% 
% 
% 
\subsection{Results}
% 
\begin{figure}[!t]
\centering
% \resizebox{1.0\textwidth}{!}{
\includegraphics[width=\textwidth, page=1]{dev/rc1/cube_2pop_orientation_hist2d_output_cube_2pop_135_rc1_.pdf}
% }
\caption[Model orientation histograms]{distribution of fiber segment orientation in initial and resulting models for $\fiberRadius = \SI{1}{\micro\meter}$. \itodo{fit ESAG} \ITODO{these are only resulting models!}}
\label{fig:modelOrientation}
\end{figure}
% 
% \begin{figure}[p]
% \centering
% % \resizebox{1.0\textwidth}{!}{
% \includegraphics[width=\textwidth, page=1]{dev/rc1/cube_2pop_orientation_hist_output_cube_2pop_135_rc1_.pdf}
% % }
% \caption[Model orientation histograms]{Maximum normed distribution of fiber segment orientation in initial and resulting models. The left half circle contains the inclination $\alpha$ value, the right half the direction $\varphi$. \itodo{which norm?}}
% \label{fig:modelOrientationHist1d}
% \end{figure}
% 
The results are visualized in two polar axis plots in \cref{fig:modelOrientationHist1d}. On the right hemisphere the direction histogram is shown.
The left hemisphere shows the inclination distribution.
Both plots are decoupled from each other. \todo{histograms mit line plots?}
Each value is normed to the maximum of that curve so that the shape is visible.
A 3d visualized model is printed in the corner of each parameterset.
% 
The subset of results show that for all radii the fibers rich the same resulting distribution of orientations. 
These distributions are broder than the inital values and are centered around their initial orientations.
The resulting 3d visualized models show all an interwoven structure, where both fiber population orientations are clearly visible. \todo{anhang}
%  
\subsection{Discussion}
%
% 
