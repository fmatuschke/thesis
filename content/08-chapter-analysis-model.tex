\newpage\null\thispagestyle{empty}\newpage
\clearpage{\thispagestyle{empty}\cleardoublepage}
\part{Software application and evaluation}
% \acbarrier
\parttoc
% 
% 
% 
\setcounter{chapter}{7}
\chapter{Dense nerve fiber modelling}
\label{cha:model_analysis}
% 
\section{Introduction}
%
In the previous chapter \cref{chap:sof:modelling}, the module \pymodule{fastpli.model} was described to create non-colliding nerve fiber models.
An important question is how the software parameters affect the resulting models.
\par
%
Three conditions are requiret from the software.
First, it must be possible to generate a dense volume.
This, of course, depends on the original fiber configuration.
For exampe in configurations such as crossings, the density is lower.
The second requirement is the runtime.
The lower the runtime is, the more objects and larger volumes the user can create in the same time.
The last condition is that the initial fiber orientations remain intact.
Because of the motion phase in the collision solver algorithm, they will change.
The question is how much they change and whether the results match still the user's expectations and anatomical constrains.
\par
%
To study the above requirements, generalized model parameters have to be found.
These parameters should be able to define a fiber configuration in a volume without having to describe each individual fiber.
This description could then be used for both the study of the solver parameters and the subsequent study of the \ac{3D-PLI} simulation.
\par
%
The first part of this chapter is the presentation of the parameterization to describe fiber populations.
This is followed by an study of the solver parameters on the behavior of the resulting collision-free nerve fiber models.
On this basis, a set of software parameters will be determined to create a library of nerve fiber models for \ac{3D-PLI} simulations.
The final part investigates the orientation distribution of the generated models.
%
%
%
\section{Designing fiber populations}
%
For the \ac{3D-PLI} simulation, a volume of size $\SI{65}{\micro\meter} \times \SI{65}{\micro\meter} \times \SI{60}{\micro\meter}$ is required (see \cref{cha:simulation_analysis}. \footnote{\SI{65}{\micro\meter} is divisible by \SI{1.3}{\micro\meter}, the pixel size of the microscope}
In this thesis, up to two fiber populations are investigated.
A fiber population is a fiber bundle with a specific orientation, density, and radius distribution.
\footnote{This strategy is also used in \ac{dMRI} \cite{Ginsburger2018,Ginsburger2019,ginsburgerDis2019}.}
These parameters of a fiber population have the advantage of being anatomically motivated and describing a nerve fiber volume based on statistical properties that are also commonly used in \ac{dMRI}.
The number of fiber populations is limited to two in order to reduce the degrees of freedom within the models.
%
% 
% 
\subsection{Orientation and proportions}\label{sec:modelParamet}
%
\begin{figure}[t]
\centering
\setlength{\tikzwidth}{0.40\textwidth}
\subcaptionbox{\label{fig:modelrotcube}A spherical volume of diameter $d$ is used as a boundary, so that a cube of side length $1/1.5 \cdot d$ can be cut in any orientation within the sphere.}
[.475\textwidth]{\inputtikz{gfx/model/sphere_cube}}\hfill
\subcaptionbox{\label{fig:modelinit}Initial orientation for two fiber populations $F_0$ and $F_1$. The angle between the two populations is $\modelOmega$. The remaining degrees of freedom are considered by rotating the whole volume (see \cref{fig:modelrotcube}).}
[.475\textwidth]{\inputtikz{gfx/model/sphere_models}}
\\
%
\subcaptionbox{The first fiber population is stationary. The second fiber population is described by the opening angle $\modelOmega$ and a rotation $\modelRot$ around the first fiber population.}
[.475\textwidth]{\inputtikz{gfx/model/sphere_models_a}}\hfill
\subcaptionbox{\label{subfig:Test1}increasing inclination for first fiber population}
[.475\textwidth]{\inputtikz{gfx/model/sphere_models_b}}
% \\
% %
% \setlength{\tikzwidth}{0.40\textwidth}
% \subcaptionbox{\label{subfig:sphere:hista1} The 3d plots above can be represented as 2d polar plots. The thicker circle indicates the currect orientation of the first fiber population.}
% [.475\textwidth]{\inputtikz{gfx/model/sphere_hist_a}}\hfill
% \subcaptionbox{\label{subfig:sphere:histb} The 3d plots above can be represented as 2d polar plots.}
% [.475\textwidth]{\inputtikz{gfx/model/sphere_hist_b}}
% \caption{Parameterization of two mutually relatively oriented fiber populations for the creation of a library.}
\label{fig:twomodelpopdesign}
\end{figure}
%
Only one model is needed to study a single fiber population, since the model can be rotated to any 3d orientation (see \cref{fig:modelrotcube}). 
For two fiber populations, the crossing angle $\modelOmega$ between the two fiber population orientations is relevant (see \cref{fig:modelinit}).
Because \ac{3D-PLI} measures the orientation the crossing angle only needs to be varried in between $\SI{0}{\degree}$ and $\SI{90}{\degree}$.
As in the case of a single fiber population, two a model of two fiber populations with a specific crossing angle can be rotated into any 3d orientation.
\par
% 
An additional parameter for both models is the population fraction $\modelPsi=\frac{N_0}{N_0+N_1}$.
This can range between $\SI{0}{}$ and $\SI{1}{}$.
Since only dense \ac{WM} phantoms are generated in this study, a lower density of $\SI{1}{}$ is not investigated.
\par
%
Therefore the following parameters are chosen, allowing up to two fiber populations to be studied:
% 
\begin{align}
    \begin{split}
        \modelOmega &= \{\SI{0}{\degree}, \SI{10}{\degree}, ..., \SI{90}{\degree}\}\\
        \modelPsi &= \{\SI{0.1}{}, \SI{0.2}{}, ..., \SI{0.9}{}\}
    \end{split}
\end{align}
% 
In the case of $\modelPsi = 0$ or $\modelPsi = 1$, no second fiber population exists, so the single fiber population model can be applied.
This results in a total of $\SI{91}{}$ required models.
%
% 
% 
\subsection{Fiber placement and randomization}
%
To design the individual fiber configurations for each fiber population, the methods described in \cref{sec:sandbox} are used, \ie{} generating fiber bundles with seed points.
The seed points on a 2d plane are generated with a uniform distribution:
\begin{align}
p = (\mathrm{Uniform}(-\frac{1}{2}\mathit{L}, \, \frac{1}{2}\mathit{L}), \mathrm{Uniform}(-\frac{1}{2}\mathit{L}, \, \frac{1}{2}\mathit{L}))
\end{align}
The size $\mathit{L}$ of the seed points surface must be chosen so that it later completely fills the volume of the model.
Since the simulation model will be cubic and the model will be rotated, a spherical boundary with diameter $d_{\mathit{sphere}}=\sqrt{3} \cdot \mathit{L}$ is chosen, where $\mathit{L}$ is the length of the largest edge length of the cube.
To ensure complete filling, $\mathit{L}$ is increased by two fiber diameters.
This ensures that objects exist outside the volume that can build up pressure on the interior.
In this way, edge effects should be prevented.
The number of seed points is set to a value of
\begin{align}
N_{0,\mathit{seeds}} &= \modelPsi \frac{A}{\pi \cdot \fiberRadiusMean}\\
N_{1,\mathit{seeds}} &= (1-\modelPsi) \frac{A}{\pi \cdot \fiberRadiusMean}
\end{align}
which corresponds to filling the entire cross-sectional area with the sum of all fiber cross-sections, taking into account the proportion of fiber populations.
In this way, more fibers are placed in the volume than they have space for, since the stacking of circles is mathematically reduced to a volume fraction of $\frac{\pi \sqrt{3}}{6} \approx 0.9$.
Statistically, this leads to overlapping of areas and displacement of fibers from the \ac{VOI}.
\par
%
\begin{figure}[!t]
\centering
% \tikzset{external/export=false}
\begin{tikzpicture}[scale=1, trim axis left, trim axis right]
        \begin{axis}[%
            height=0.46\textwidth, width=0.75\textwidth,
            enlargelimits=false, xlabel={$x$},
            ylabel={$f(x,\mu,\sigma)$},
            title=${f(x,\mu,\sigma)=\frac{1}{\sigma x \sqrt{2\pi}}\exp\left(-\frac{(\ln(x)-\mu)^2}{2 \sigma^2}\right)}$,
            legend style={at={(1,1)},anchor=north east},
            legend cell align={left},
        ]
        \pgfmathsetmacro{\muValue}{0}
        \pgfmathsetmacro{\sigmaValue}{0.05}
        \addplot[BLUE,thick,domain=0.6:1.4, samples=2*42, smooth]{1/(\sigmaValue*x*sqrt(2*pi))*exp(-(ln(x)-\muValue)^2/(2*\sigmaValue^2))}; \addlegendentry{$\mu=0.0,\sigma=0.05$}
        \pgfmathsetmacro{\muValue}{0}
        \pgfmathsetmacro{\sigmaValue}{0.1}
        \addplot[GREEN,thick,domain=0.6:1.4, samples=2*42, smooth]{1/(\sigmaValue*x*sqrt(2*pi))*exp(-(ln(x)-\muValue)^2/(2*\sigmaValue^2))}; \addlegendentry{$\mu=0.0,\sigma=0.1$}
    \end{axis}
\end{tikzpicture}
\caption[]{Probability density function of a multiplicative \name{log normal} distribution. $\sigma=0.1$ is used for the initial variation of each fiber radius. $\sigma=0.05$ for the variation along the fiber for each fiber point.}
\label{fig:logNormal}
\end{figure}
%
These seed points are used to place straight, parallel fibers within a cubic volume.
To add a random distribution of fiber radii, the target mean fiber radius $\fiberRadiusMean$ is multiplied by a random value of the LogNormal distribution (see \cref{fig:logNormal}) to ensure that the mean value is preserved:
\begin{align}
\fiberRadius = \fiberRadiusMean \cdot \mathrm{sample}\left(\mathrm{LogNormal}(\mu=0, \, \sigma=0.1)\right)
\end{align}
%
To achieve a more random distribution along the fibers, the fibers must first be divided into fiber segments.
This is where the \code{Solver} class helps with its \code{Solver.apply\_boundaries()} method.
It applies the set fiber segment length to the fiber configuration, which in this case divides the fiber along its trajectory into fiber segments of equal length (except for the last segment).
The fiber points generated in this way are then randomly shifted in all three dimensions with a normal distribution and a value that depends on the average fiber radii \fiberRadiusMean{}.
In addition, the radius of the point is changed with a random multiplicative factor from a LogNormal distribution:
%
\begin{align}
\begin{split}
p_i &= p_i + \mathrm{Normal}(\mu=0,\sigma=0.05 \cdot \fiberRadiusMean)\\
r_i &= r_i \cdot \mathrm{LogNormal}(\mu=0,\sigma=0.05)
\end{split}
\end{align}
%
%
%
\subsection{Parameter characterization}\label{sec:modelSetup}
%
The control mechanisms described in the algorithm of the collision solver \code{fastpli.model.solver} (see \cref{chap:sof:modeling}) have to be characterized.
These are the mean segment length \segLength{} and the minimum allowed radius of curvature \segRadius{}.
It must be ensured that a parameter set is identified that ensures that the configurations entered by the user remain the same, i.e., the orientation distributions remain intact with respect to the fact that the fiber segments must move.
In addition, the achievable fiber density should remain high for this set of parameters.
Finally, it must also be ensured that a parameter set can be chosen that has an acceptable runtime.
If possible, the runtime time should be minimized, since it is a limited resource.
\par
%
To investigate the behavior of \segLength{} and \segRadius{}, the two factor variables \segLengthFactor{} and \segRadiusFactor{} are defined:
\begin{align}
    \begin{split}
        \segLength &= \segLengthFactor \cdot \fiberRadiusMean\\
        \segRadius &= \segRadiusFactor \cdot \fiberRadiusMean
    \end{split}
\end{align}
This allows an investigation of the model characterization independent of the fiber radius.
The parameter ranges chosen to study the effects are listed in \cref{tab:parameterSetupChar}.
%
\begin{table}[!b]
\sisetup{parse-numbers=false,open-bracket={\{}, close-bracket={\}}, list-final-separator={,},list-pair-separator={,}}%
\centering
\pgfplotstabletypeset[%
    thesisTableStyle,
    column type=lcl,
    columns/name/.style={string type},
    columns/variable/.style={string type},
    columns/values/.style={string type},
    every head row/.style={before row=\toprule,after row=\midrule},
    every last row/.style={after row=\bottomrule},
    col sep=&,
    row sep=\\,
    % string type,
]
{name & variable & values\\
mean fiber radius & $\fiberRadiusMean$ & $\SIlist{0.5;1;2;5;10}{\micro\meter}$\\
mean segment length factor & $\segLengthFactor$ & $\numlist{1;2;4;8}$\\
min segment bending radius factor & $\segRadiusFactor$ & $\numlist{1;2;4;8}$\\
% fiber bundle distribution value & $\textcolor{violet}{\modelPsi}$ & $\numlist{0.1;0.2;...;1.0}$ \\
% fiber bundle crossing angle & $\textcolor{violet}{\modelOmega}$ & $\SIlist{0;10;...;90}{\degree}$\\
fiber bundle crossing/proportion & $\modelPsi$/$\modelOmega$ & $\SI{1.0}{}/\SI{0}{\degree}$, $\SI{0.5}{}/\SI{90}{\degree}$\\
}
\caption{Selection of the parameter ranges for the characterization of the parameters.}
\label{tab:parameterSetupChar}
\end{table}
%
To be able to statistically verify the results, the generation of the models $n_{\mathit{repeat}} = \SI{24}{}$ was repeated.
For characterization, only $\modelPsi/\modelOmega$ pair of $\SI{1.0}{}/\SI{0}{\degree}(||)$ and $\SI{0.5}{}/\SI{90}{\degree}(\times)$ are considered as extreme cases.
The number of steps is limited to $\SI{100000}{}$ to constrain the computation.\footnote{In hindsight, this should have been limited by the runtime}
A cubic volume of $\SI{60}{\micro\meter} \times \SI{60}{\micro\meter} \times \SI{60}{\micro\meter}$ is chosen for this characterization.
Every 50 steps, the fiber model is cut into a $\SI{60}{\micro\meter}+4 \cdot \fiberRadiusMean$ cube to delete unnecessary fibers and reduce the number of objects.
After this process, the metainformation is stored for time evaluation.
For orientation analysis, the volume is reduced to $\SI{60}{\micro\meter}$ to neglect the protruding fiber segments.
To measure the volume fraction, the discretized volume from the simulation is generated from the simulation module.
There, the individual label IDs are counted to calculate the volume fraction.
The machine used to calculate all models is an
Intel(R) Xeon(R) CPU E5-4657L v2 @ \SI{2.4}{\giga\hertz}, L1d cache: \SI{1.5}{\mega\byte}, L1i cache: \SI{1.5}{\mega\byte}, L2 cache: \SI{12}{\mega\byte}, L3 cache: \SI{120}{\mega\byte}.
%
%
%
\subsection{Results} \label{sec:solverParameterResults}
%
\begin{figure}[t]
\centering
\includegraphics{dev/rc1/mpara/pre_stats_box_plot_volume_05_output_parameter_statistic_rc1.pdf}
\caption[Volume fraction]{Volume fractions for parameter set.}
\label{fig:psbp1}
\end{figure}
%
\paragraph{Volume fraction}
%
\Cref{fig:psbp1} show the resulting volume fraction $V_f/V_0$ for the parameter series.
% The additional fiber radii results are available in \cref{app:appModelVolumeBoxPlot}.
\par
%
% single fiber
The single fiber populations $(||)$ have volume fractions greater than $\SI{0.74}{}$.
For constant values of the fiber segment length factor, except in the case of $\segLengthFactor = \SI{1}{}$, there is no significant change from the fiber bending radius factor.
In the case of $\segLengthFactor = \SI{1}{}$, there is a small decrease in volume fraction with increasing bend radius.
A decrease with increasing fiber segment length factor \segLengthFactor{} is more pronounced, but still small.
\par
%
% crossing fiber
This behavior changes significantly for the crossing fiber population $(\times)$.
There the values are always smaller than in the case of the single fiber population.
For $\segLengthFactor{}=\SI{1}{}$ the volume fraction decreases abruptly between $\segRadiusFactor{} = \SI{2}{}$ and $\segRadiusFactor{} = \SI{4}{}$.
For $\segLengthFactor{}=\SI{2}{}$, the change becomes smoother.
The total volume fraction decreases for values $\segLengthFactor{} \geq \SI{4}{}$ compared to the previous values.
For $\segLengthFactor{}=\SI{8}{}$ the change with \segRadiusFactor{} disappears and the volume fraction reaches only a value around $\SI{0.57}{}$.
\par
%
% radius
The behavior is the same for higher mean fiber radii (see \cref{app:appModelVolumeBoxPlot}). For values $\geq \SI{5}{\micro\meter}$, the variance increases and the median decreases significantly.
However, even when the median becomes smaller, it behaves the same across all parameters as for the smaller fiber radii.
The results show that, except for the median fiber radii $\geq \SI{5}{\micro\meter}$, the volume fraction does not change its behavior when the median fiber radii are changed.
\par
%
%
%
\paragraph{Runtime}
%
\begin{figure}[p]
\centering
Single fiber population\\[0em]
\includegraphics[page=1]{dev/rc1/mpara/pre_stats_time_evolve_r05_output_parameter_statistic_rc1.pdf}
\caption{Time evolution of the model building process of parallel fiber populations. Error bars indicate $\SI{25}{\percent}$ and $\SI{75}{\percent}$ quantiles.}
\label{fig:timeDevelopmentNone}
\end{figure}
%
\begin{figure}[p]
\centering
Crossing fiber population\\[0ex]
\includegraphics[page=2]{dev/rc1/mpara/pre_stats_time_evolve_r05_output_parameter_statistic_rc1.pdf}
\caption{Time evolution of the model building process of crossing fiber populations. Error bars indicate $\SI{25}{\percent}$ and $\SI{75}{\percent}$ quantiles.}
\label{fig:timeDevelopmentCross}
\end{figure}
%
The change in runtime $t$ of a subset of the parameter set \cref{tab:parameterSetup} is shown in \cref{fig:timeDevelopmentNone} for the single fiber population and in \cref{fig:timeDevelopmentCross} for the crossing fiber population for the number of steps, the number of colliding fiber segments, and the overlap fraction of colliding fiber segments.
The overlap fraction of colliding fiber segments is defined as the average of the minimum distance between two colliding fiber segments divided by their combined radii.
The results of the additional fiber radii are available in \cref{app:pste1,app:pste2,app:pste3,app:pste4,app:pste5}.
\par
%
% SINGLE
The single fiber populations show a strong linear correlation between the runtime and the number of steps for all parameters.
The number of steps increases significantly with decreasing \segLengthFactor{}.
A change in the running time when changing the fiber bending radius \segRadiusFactor{} is not visible in the logarithmic plot.
The total number of steps increases slightly with an increase in the fiber segment length factor \segLengthFactor{}.
However, the total running time increases significantly with a decrease in \segLengthFactor{}.
All models of all parameter sets were able to solve the collisions in the maximum number of steps.
\par
%
The number of colliding fiber segments in the second plot shows a strongly increasing decrease for all parameters with increasing runtime.
The total number increases with decreasing \segLengthFactor{}.
The \segRadiusFactor{} also has no significant effect here.
\par
%
The overlap fraction for all parameters is about $\SI{5}{\percent}$ at the beginning and decreases over time to about $\SI{1}{\percent}$.
The decrease is approximately linear after the initial phase
At the end of the solution process, the variance increases sharply before the model is solved and the value is therefore $\SI{0}{\percent}$.
The curve behavior between the different \segLengthFactor{} is roughly the same, except of course for an offset in the total runtime.
A difference when changing the \segRadiusFactor{} is again not visible.
\par
%
The number of objects decreases only slightly over time.
A significant increase can be seen in a decreasing value of \segLengthFactor{}.
The \segRadiusFactor{} is negligible except in the case of $\segLengthFactor = \SI{1}{}$, where the number of objects is increased.
\par
%
The last diagram shows the average time $\Delta t$ needed for a single step.
Again, the \segLengthFactor{} has the biggest influence on the results.
A change with \segRadiusFactor{} is almost not visible.
The step time slowly decreases to about half the time required for the first step.
The variance increases as the step size increases and can reach about half an order of magnitude in the case of \segLengthFactor{}.
\par
%
From the first four plots, the total runtime can be read.
Decreasing the \segLengthFactor{} increases the runtime.
This is between $\SI{1000}{\second}$ and $\SI{10000}{\second}$ for all parameters at this volume size.
\par
%
% CROSSING
The crossing fiber population in \cref{fig:timeDevelopmentCross} shows for all parameter sets an equally linear behavior for the number of steps as in the case of the single fiber population.
However, the total runtime is significantly increased compared to the models with a single fiber population.
The runtime increases significantly with a decrease in \segLengthFactor{} and decreases with a decrease in \segRadiusFactor{}.
The letter is clearly visible in the next graph.
In the case of $\segLengthFactor = \SI{1}{}$ and $\segLengthFactor = \SI{2}{}$, the maximum number of steps is reached.
For $\segLengthFactor = \SI{1}{}$ this has happened after $\SI{24}{\hour}$.
\par
%
The number of colliding fiber segments shows the same decreasing behavior in the case of the smallest \segRadiusFactor{} as for the single fiber population.
The key difference is that this behavior changes dramatically with an increase in the minimum fiber bending radius factor \segRadiusFactor{}.
The curves appear to split at a critical number of steps (or runtimes), and from then on they fall off in an increasingly linear fashion for higher \segRadiusFactor{} and smaller \segLengthFactor{}.
The number of splits increases with decreasing \segLengthFactor{} and does not increase in the case of $\segLengthFactor = \SI{8}{}$.
The split point is close to the total runtime of the lowest \segRadiusFactor{} in terms of runtime.
\par
%
The overlap fraction shows a significant difference for the smaller fiber segment length factor \segLengthFactor{} compared to the single fiber population case.
For high \segLengthFactor{} values, the curve follows almost the same path as in the single fiber population case, ending in the solute state.
However, for lower values and depending on the \segRadius{}, the curve continues at about $\SI{1}{\percent}$ overlap.
In the case of $\segLengthFactor = \SI{1}{}$ and $\segRadiusFactor = \SI{8}{}$, it even starts to grow slightly again at the end of its lifetime.
\par
%
The number of objects shows the same behavior as in the case of the single fiber population.
A slight decrease in the number and a significant increase for a decreasing value of the \segLengthFactor{} is visible.
The splitting of the curves for the \segRadiusFactor{} is also visible, but not as pronounced as in the case of the number of colliding objects.
In the case of $\segLengthFactor = \SI{1}{}$ and $\segRadiusFactor = \SI{8}{}$, an increase of objects is observed in the last phase of the solution algorithm.
\par
% 
The time required for a single step decreases for all parameters over the number of steps until it reaches a constant value for each \segLengthFactor{}.
The \segRadiusFactor{} does not seem to play a significant role.
For $\segLengthFactor{} = \SI{8}{}$, the variance increases again at the end of the runtime, as in the case of the single fiber population, but not as much.
In the case of $\segLengthFactor{} = \SI{1}{}$ and $\segRadiusFactor = \SI{8}{}$, one can observe an increase in the step time at the end of the runtime.
\par
%
The total runtime is influenced by both the \segLengthFactor{} and the \segRadiusFactor{}.
The splitting behavior visible in the graph of the number of colliding objects shows the significant difference in runtime for the \segRadiusFactor{}.
Increasing the \segRadiusFactor{} can result in an increase in runtime for this parameter by up to an order of magnitude.
The differences between the \segLengthFactor{} are comparable to the single fiber case.
\par
%
The other fiber radii show very similar behavior.
The strongest difference is a very significant decrease in runtime with an increase in \fiberRadiusMean{} (see \cref{app:pste1,app:pste2,app:pste3,app:pste4,app:pste5}).
%
%
%
\subsection{Discussion}
%
The goal is to find a parameter set that is a) fast, b) collision-free, and c) allows a high volume fraction for dense fibers.
For parallel fibers, the solution process is always faster than for intersecting bundles.
Even if the number of colliding objects is more or less the same, the volume required to have enough space to not collide with each other is larger.
This is visible in the overlap fraction \cref{fig:timeDevelopmentNone,fig:timeDevelopmentCross} plot.
The overlap is significantly higher in the crossing fibers than in the single fiber case.
This not only means that the fiber segments that need to be moved out of the way are longer, but also that the fiber segments that are inserted into the octree contain more multiple cases and the number of objects per octree leaf is higher.
This significantly increases the runtime to solve the volume.
\par
%
% \segLengthFactor
\segLengthFactor{} is the most important parameter to reduce the runtime for constant \fiberRadiusMean{} because the number of objects is also smaller.
However, a larger \segLengthFactor{} results for crossing fibers, as would be expected with a smaller volume fraction.
For parallel fibers, it makes sense that the volume fraction does not change, since the direction of motion for all fiber segments is radially symmetric along their principal orientation axis.
\par
%
% \segRadiusFactor{}
Since the fiber segment bending radius factor \segRadiusFactor{} restricts the bending radius, it is to be expected and visible in the results that the volume fraction is strongly influenced since the volume can no longer be filled optimally.
As before, changing the \segRadiusFactor{} should not lead to any difference in the single fiber case.
However, crossing fibers are strongly influenced.
This is especially evident in the number of colliding objects, where the \segRadiusFactor{} splits the data into individual branches over time.
Here, smaller values of \segRadiusFactor{} allow for more curved geometries.
However, this can lead to unnatural results in terms of anatomical structure.\todo{images}
Theoretically, a fiber could deform like a ball of yarn, for example.
And once the fibers in a volume are bent, the algorithm is unlikely to be able to remove these severe bends.
Consequently, much of the volume would be filled with fibers, or rather fiber segments, but the actual number of fibers would be reduced.
An interesting effect for smaller \segLengthFactor{} and higher \segRadiusFactor{} is visible.
The number of colliding objects starts increases again, as does the total number of objects.
Especially the latter is an unexpected effect, since the volume is limited.
With these data, it is not possible to further investigate the origin of this effect.
However, it is safe to say that larger \segRadiusFactor{} should be avoided, as this effect also affects the data for $\segLengthFactor = 2$ and $\segRadiusFactor \geq 4$.
However, since such a large radius factor represents an unnatural stiffness for a nerve fiber, this is not a problem for this type of model.
\par
%
Overall, the selection of parameters can be narrowed down.
The most important decision results from the crossing fiber population results.
Because the most essential parameter is the length factor \segLengthFactor{}.
If we consider the results of the volume fraction, it should be as small as possible.
But since the difference between $\segLengthFactor=\SI{1}{}$ and $\segLengthFactor=\SI{2}{}$ is small, and for $\segLengthFactor=\SI{4}{}$ a big jump becomes visible, one can reduce the running time significantly with $\segLengthFactor=\SI{2}{}$.
\par
%
The choice of the fiber bending radius factor \segRadiusFactor{} is an anatomical \dummy{} constraint.
To counteract excessive deformation, a value of at least $\segRadiusFactor = \SI{2}{}$ should be chosen.
An even larger value is especially important for large \segLengthFactor{} to greatly increase the runtime and unnatural stiffness mentioned above.
The \segLengthFactor{} should be as small as possible to achieve the highest accuracy.
However, the runtime increases too much.
Therefore, a value of $\segLengthFactor = \SI{2}{}$ was chosen, since higher values already show a significant influence on the volume fraction.
\par
%
In summary, the following parameters were chosen:
%
\begin{table}[H]
\sisetup{parse-numbers=false,open-bracket={\{}, close-bracket={\}}, list-final-separator={,},list-pair-separator={,}}%
\centering
\caption{Recommended parameters of model generation.}
\pgfplotstabletypeset[%
    thesisTableStyle,
    column type=lcc,
    columns/name/.style={string type},
    columns/variable/.style={string type},
    columns/values/.style={string type},
    every head row/.style={before row=\toprule,after row=\midrule},
    every last row/.style={after row=\bottomrule},
    col sep=&,
    row sep=\\,
]
{name & variable & values\\
mean fiber radius & $\fiberRadiusMean$ & $\SI{0.5}{\micro\meter}$\\
mean segment length factor & $\segLengthFactor$ & $\num{2}$\\
min segment bending radius factor & $\segRadiusFactor$ & $\num{2}$\\
}
% \vspace{1ex}
\label{tab:parameterSetup}
\end{table}
%
For fiber radii $\fiberRadiusMean > \SI{0.5}{\micro\meter}$, the most important effect is the shortening of the runtime at constant volume.
In addition, boundary effects become apparent due to the limited volume.
For example, the mean volume fraction for each configuration decreases significantly and the variance increases.
This is the effect of being able to fit only a few fibers in a $\SI{60}{\micro\meter}$ thick volume.
If these are then randomly arranged and deformed, as in this case, the volume fraction must decrease.
If the volume were infinite, there would be no difference between the results since all parameters are independent of the radii.
Therefore, an increase in the fiber radii should be considered if the volume to be calculated is larger or the runtime is imperative.
It should then be verified that the simulation does not cause significant changes in the results.
\par
%
Another way to shorten the runtime is to not solve the model completely.
Looking at the overlap fraction, a value of $<\SI{1}{\percent}$ may be feasible.
It should be noted that this is only the fraction of the fiber segment that still overlaps.
The number of colliding fiber segments decreases steadily for the chosen parameters
This can potentially save an order of magnitude.
However, the influence on the simulation must also be investigated here beforehand.
%
%
%
\section{CPU Acceleration}
%
As described in \cref{sec:modelOpt}, \ac{OpenMP} is used to accelerate \code{for} loops.
This means that it is currently not possible to use multiple compute nodes.
\par
% 
To investigate the speedup runtime measurements the parameters from \cref{tab:parameterSetup} are used for parallel and crossing fibers.
The chossen volume is of size $\SI{60}{\micro\meter} \times \SI{60}{\micro\meter} \times \SI{60}{\micro\meter}$.
The speedup is calculated for an avarage of 100 consecutive steps.
To measure if the speedup changes over time the time measurements are started after a certain number of steps $\Delta_{\mathit{steps}} = \SIlist{0;100;1000;10000}{\steps}$ .
The calculation is repeated $n=\SI{24}{}$ times for each case.
For the measurements the cores were bind to phyical cpu cores and not to hyperthreaded cores.
%
% 
% 
\subsection{Results}
% 
\begin{figure}[!t]
\centering
\includegraphics[page=1]{dev/rc1/speed/boxplot_output_r_0.5__.pkl_speedup.csv.pdf}
\caption{\code{model.Sovler} speedup. Timing measurements are performed after $\Delta_{\mathit{steps}}$ for the next $\SI{25}{\steps}$ for parallel $(||)$ and crossing $(\times)$ fiber configurations.}
\label{fig:solverSpeedup}
\end{figure}
% 
The plot \cref{fig:solverSpeedup} show for the different starting positions $\Delta_{\mathit{steps}}$ as well as for the parallel and crossing fiber bundles.
Up to $\SI{4}{cores}$ the speedup inreases linear for $\SI{4}{cores}$ with a number of 3 \dummy{}.
After $\SI{4}{cores}$ the speedup increases slower until for $\SI{8}{cores}$ a significant increas tp a speedup of about $\SI{5}{}$ is visible.
\par
% 
Overall there is no significant change for parallel or crossing fibers visible.
A change in speedup is also not visible for different starting points $\Delta_{\mathit{steps}}$.
\par
% 
Higher core numbers up to $\SI{48}{cores}$ are listed in \cref{app:solverSpeedupAll}.
The speedup raises upt to $\SI{8}{}$ for the last case.
There are also outliers visible which come from a slow $\SI{1}{core}$ measurement.
% 
% 
% 
\subsection{Discussion}
% 
Up to $\SI{4}{cores}$ the speedup is with $\SI{3}{}$ ok.
The slower rise and the jumpt for $\SI{8}{cores}$ is to be explained by the structure of the \name{octree}.
Since for $\SI{8}{cores}$ the parallel balancing (can) be optimal on an \name{octree} the speedup has to rise.
Higher cpu cores are not feasable.
\par
% 
Nonetheless, the data suggest that using a multicore system significantly reduces untime.
However, for small volumes or low-fiber objects, one should use only one or two cores and prefer to run multiple models in parallel.
The results also show that an optimized algorithm is needed especially for increasing the volume or object count.
Here, the \ac{GPU} seems to be the hardware of choice with an more advanced algorithm \cite{Karras2012}.
% 
%
%
\section{Simulation nerve fiber model library}
%
With the model parameters selected above (see \cref{sec:modelSetup}), the simulation models can be generated.
As described in \cref{sec:modelParamet}, only fibers with a $\modelOmega = \SIrange{10}{90}{\degree}$ and $\modelPsi = \SIrange{0.1}{0.9}{}$ are generated with the addition of $\modelOmega=\SI{0}{\degree}, \modelPsi=\SI{1.0}{}$.
The volume for the simulation is scaled up to a sphere with a diameter of \SI{135}{\micro\meter} so that a simulated volume can be generated from the sphere in any orientation with the tipping boundary added.
In this section, the resulting orientation within the volume, \ie{} the orientation of the fiber segments, will be analyzed before being used in the simulation in the next chapter.
%
%
%
\subsection{Results}
%
\begin{figure}[!t]
\centering
% \resizebox{1.0\textwidth}{!}{
\includegraphics[width=\textwidth, page=1]{dev/rc1/model/cube_2pop_orientation_hist2d_output_cube_2pop_135_rc1.pdf}
% }
\caption{Density distribution of fiber segment orientation in the simulation models. The color of the segments is weighted by the area on a spherical surface. The value is normalized so that the integral over a hemisphere is 1. The dashed white line indicates the orientation of the two fiber populations.}
\label{fig:modelOrientation}
\end{figure}
%
\begin{figure}[!t]
\centering
\includegraphics[page=1]{dev/rc1/images/cube_2pop_images_output_cube_2pop_135_rc1.pdf}
\caption[solved model images]{Simulation model library. The inner $\SI{10}{\micro\meter} \times \SI{10}{\micro\meter} \times \SI{10}{\micro\meter}$ of the volume is shown.}
\label{fig:modelImages}
\end{figure}
%
\begin{figure}[!t]
    \centering
    \includegraphics[]{dev/rc1/domega/cube_2pop_domega_analysis_output.pdf}
    \caption{Direction and inclination distribution of simulation model library. \todo{benutze ich das irgendwo?}}
    % \label{fig:my_label}
\end{figure}
%
\Cref{fig:modelOrientation} shows the orientation distribution as a polar histogram for the fiber segments in a subset of the models.
The hole dataset is available in \cref{app:modelOrientation}.
The distribution shows symmetry that matches well with the initialized orientation.
The analyzed orientations as statistics of the opening angle of each population \popa and \popb are shown in \cref{fig:modelImages} for the innermost $\SI{10}{\micro\meter}$ cube, making it easier to see the individual fibers.
\par
%
The distribution of fiber segment orientation of the models shows a local boundary of each fiber population with a variance around the main population orientation.
\Cref{app:modelDistribution} show that for all crossing angles $\modelOmega$, the mean opening angle $\langle \openingAngle
 \rangle$ is around $\SI{20}{\degree}$ \todo{exact value}.
The variance $\sigma_{\modelOmega}$ is around $\SI{11}{\degree}$.
Since the distribution is not a normal distribution, the quantiles are also given.
The upper quantile $\SI{75}{\percent}$ shows values up to $\SI{29}{\percent}$.
A significant difference between the first and second fiber population distributions is that the more strongly represented distribution has a smaller aperture angle and a lower variance and quantile.
\par
% 
The inclination $\alpha$ and direction $\phi$ were calculated by centering the orientation on the main orientation of the fiber populations and then applying the functions.
Both the mean and median orientations of the populations agree well with the target value.
The standard deviation for the subset presented here is about $\SI{18}{\degree}$ for the slope and $\SI{16}{\degree}$ \todo{recalculate!} for the direction.
It is important to note that the angles for the inclination and the direction are dependent on each other.
Therefore, the opening angle is also calculated.
\par
%
The images in \cref{fig:modelImages} show the woven pattern within the collision-free model.
Multiple layers of fibers are interwoven, with one layer appearing to have a thickness of about one fiber diameter.
Several instances are seen where multiple fibers appear to move as a unit through the woven pattern.
Wobbling of individual fibers is also visible in fibers with a low density within the fiber population.
Depending on the parallel or crossing fibers, the runtime was in the range of $\SIrange{32}{40}{\hour}$ and $\SIrange{11000}{17000}{\steps}$.
%
% 
% 
\subsection{Discussion}
% 
The orientation distribution of the simulation model library is stable for all crossing angles.
However, the distribution variance is smaller for the main fiber bundle and larger for the other.
This is plausible because the main fiber bundle exerts more radial pressure on the orientation, resulting in a more stable configuration for cylindrical objects.
This will properly have a minor effect on the simulation results, leading to a higher retardation for parallel or highly dominant fiber bundles compared to intersecting and uniformly distributed fiber bundles.
However, this effect is less significant than the shrinkage of the volume fraction, which results in fewer fibers within the volume and thus less retardation in addition to the main reduction effect of an intersecting region.
For stiff models, a higher variance of the angular distribution is reasonable.
Whether this is also true for anatomical tissue remains to be explored.
Measurements such as electro-microscopy make the analysis of soft structures difficult, since the\textbf{} necessary vacuum strongly deforms the tissue.
\ac{TPFM}, on the other hand, have the disadvantage that in densely populated regions the fibers overlap the images and individual fibers can no longer be detected.
However, since real nerve fibers are not stiff and also not perfectly cylindrical, it can be assumed that from a geometric point of view the angular distribution should be smaller than in these generated models.
Which influence the growth and myelination process of the axons has on their geometry, however, is an open question in this context.
\par
%
These models have the advantage of producing a naturally inspired angular distribution, which should result in a more realistic distribution of the \ac{3D-PLI} simulation signal.
The measured signal of the \ac{3D-PLI} is independent of the vertical position of the fiber, the optical axis, and therefore the interlacing pattern is not that important.
This is also the reason why a homogeneously interwoven pattern of nerve fibers is acceptable even if the anatomical intersection has a different number of layers, as long as the ratio is the same in an image voxel or, better yet, in the path of the light beams.
However, with an inclined light beam and tilting analysis, this becomes a source of error.